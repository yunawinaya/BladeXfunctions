[
  {
    "id": "condition_or_node_iH8xSgqb",
    "type": "condition-or-node",
    "data": {
      "title": "Status Condition",
      "filter": { "list": [] },
      "expression": { "code": "" },
      "displayContent": "sdk.form.setCondition"
    },
    "blocks": [
      {
        "id": "condition_or_node_item_RDO2qrYq",
        "type": "condition-or-node-item",
        "data": {
          "title": "Pending",
          "filter": {
            "list": [
              {
                "id": 1769566352966,
                "parentId": 1769566352965,
                "isTop": true,
                "prop": "",
                "operator": "",
                "valueType": "",
                "value": "",
                "type": "leaf",
                "level": 1
              }
            ]
          },
          "expression": {
            "code": "'{{workflowparams:status}}' == 'Pending'",
            "type": "javascript"
          },
          "displayContent": "sdk.form.setCondition",
          "isValidator": true,
          "nodeName": "Pending",
          "name": "Pending",
          "condition_type": "Expression"
        },
        "blocks": [
          {
            "id": "condition_or_UVzorajc",
            "type": "condition-or-node",
            "data": {
              "title": "Document Type",
              "filter": { "list": [] },
              "expression": { "code": "" },
              "displayContent": "sdk.form.setCondition"
            },
            "blocks": [
              {
                "id": "condition_or_node_item_K1IY6jQX",
                "type": "condition-or-node-item",
                "data": {
                  "title": "Sales Order",
                  "filter": {
                    "list": [
                      {
                        "id": 1769566212162,
                        "parentId": 1769566212161,
                        "isTop": true,
                        "prop": "",
                        "operator": "",
                        "valueType": "",
                        "value": "",
                        "type": "leaf",
                        "level": 1
                      }
                    ]
                  },
                  "expression": {
                    "code": "'{{workflowparams:doc_type}}' == 'Sales Order'",
                    "type": "javascript"
                  },
                  "displayContent": "sdk.form.setCondition",
                  "isValidator": true,
                  "nodeName": "Sales Order",
                  "name": "Sales Order",
                  "condition_type": "Expression"
                },
                "blocks": [
                  {
                    "id": "add_node_fSjLz3x9",
                    "type": "add-node",
                    "data": {
                      "table_id": {
                        "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                        "rules": {
                          "collectionId": "1935880014687440897",
                          "list": [
                            {
                              "id": 1769566749982,
                              "parentId": 1769566749981,
                              "isTop": true,
                              "prop": "",
                              "operator": "",
                              "valueType": "",
                              "value": "",
                              "type": "leaf",
                              "level": 1
                            }
                          ]
                        }
                      },
                      "fields": [],
                      "title": "Add Reserved Table",
                      "isValidator": true,
                      "nodeName": "Add Reserved Table",
                      "name": "Add Reserved Table",
                      "props": {
                        "modelName": "",
                        "list": [
                          {
                            "prop": "doc_type",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_type}}",
                            "operator": "",
                            "valueLabel": "",
                            "propLabel": "Document Type"
                          },
                          {
                            "prop": "status",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:status}}",
                            "valueLabel": "",
                            "propLabel": "Status"
                          },
                          {
                            "prop": "parent_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent ID"
                          },
                          {
                            "prop": "parent_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent Line ID"
                          },
                          {
                            "prop": "parent_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_no}}",
                            "valueLabel": "",
                            "propLabel": "Parent Number"
                          },
                          {
                            "prop": "doc_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_no}}",
                            "valueLabel": "",
                            "propLabel": "Document Number"
                          },
                          {
                            "prop": "doc_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_id}}",
                            "valueLabel": "",
                            "propLabel": "Document ID"
                          },
                          {
                            "prop": "doc_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Document Line ID"
                          },
                          {
                            "prop": "material_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_id}}",
                            "valueLabel": "",
                            "propLabel": "Item ID"
                          },
                          {
                            "prop": "item_code",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_code}}",
                            "valueLabel": "",
                            "propLabel": "Item Code"
                          },
                          {
                            "prop": "item_name",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_name}}",
                            "valueLabel": "",
                            "propLabel": "Item Name"
                          },
                          {
                            "prop": "item_desc",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_desc}}",
                            "valueLabel": "",
                            "propLabel": "Item Description"
                          },
                          {
                            "prop": "batch_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:batch_id}}",
                            "valueLabel": "",
                            "propLabel": "Batch ID"
                          },
                          {
                            "prop": "bin_location",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:location_id}}",
                            "valueLabel": "",
                            "propLabel": "Bin Location"
                          },
                          {
                            "prop": "item_uom",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_uom}}",
                            "valueLabel": "",
                            "propLabel": "UOM"
                          },
                          {
                            "prop": "reserved_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:quantity}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Quantity"
                          },
                          {
                            "prop": "delivered_qty",
                            "operator": "",
                            "valueType": "value",
                            "value": 0,
                            "valueLabel": "",
                            "propLabel": "Delivered Quantity"
                          },
                          {
                            "prop": "open_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:quantity}}",
                            "valueLabel": "",
                            "propLabel": "Open Quantity"
                          },
                          {
                            "prop": "reserved_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_date}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Date"
                          },
                          {
                            "prop": "line_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:index}}",
                            "valueLabel": "",
                            "propLabel": "Line No"
                          },
                          {
                            "prop": "plant_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:plant_id}}",
                            "valueLabel": "",
                            "propLabel": "Plant ID"
                          },
                          {
                            "prop": "organization_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:organization_id}}",
                            "valueLabel": "",
                            "propLabel": "Organization ID"
                          },
                          {
                            "prop": "remark",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:remark}}",
                            "valueLabel": "",
                            "propLabel": "Remark"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  },
                  {
                    "id": "workflow_node_DWZUziMB",
                    "type": "workflow-node",
                    "data": {
                      "workflow_id": "",
                      "workflow_name": "",
                      "input_params": {},
                      "title": "Subtract Inventory Workflow",
                      "isValidator": true,
                      "nodeName": "Subtract Inventory Workflow",
                      "name": "Subtract Inventory Workflow",
                      "workflow": {
                        "source": "SUBTRACT_INVENTORY:Workflow:2012096660219564034",
                        "rules": {
                          "collectionId": "2012096660219564034",
                          "list": [
                            {
                              "id": 1723795236686,
                              "parentId": 1723795236685,
                              "isTop": true,
                              "prop": "",
                              "operator": "",
                              "valueType": "",
                              "value": "",
                              "type": "leaf",
                              "level": 1
                            }
                          ]
                        }
                      },
                      "remote": true,
                      "remoteType": "innerdatasource",
                      "body_params": {
                        "list": [
                          {
                            "prop": "plant_id",
                            "propLabel": "Plant ID",
                            "operator": "",
                            "operatorLabel": "",
                            "valueType": "field",
                            "valueTypeLabel": "",
                            "value": "{{workflowparams:plant_id}}",
                            "valueLabel": ""
                          },
                          {
                            "prop": "organization_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:organization_id}}",
                            "valueLabel": "",
                            "propLabel": "Organization ID"
                          },
                          {
                            "prop": "material_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_id}}",
                            "valueLabel": "",
                            "propLabel": "Material ID"
                          },
                          {
                            "prop": "quantity",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:quantity}}",
                            "valueLabel": "",
                            "propLabel": "Quantity"
                          },
                          {
                            "prop": "material_uom",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_uom}}",
                            "valueLabel": "",
                            "propLabel": "UOM"
                          },
                          {
                            "prop": "transaction_type",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:transaction_type}}",
                            "valueLabel": "",
                            "propLabel": "Transaction Type"
                          },
                          {
                            "prop": "trx_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_no}}",
                            "valueLabel": "",
                            "propLabel": "Trx No"
                          },
                          {
                            "prop": "inventory_category",
                            "operator": "",
                            "valueType": "value",
                            "value": "Unrestricted",
                            "valueLabel": "",
                            "propLabel": "Inventory Category"
                          },
                          {
                            "prop": "location_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:location_id}}",
                            "valueLabel": "",
                            "propLabel": "Location ID"
                          },
                          {
                            "prop": "batch_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:batch_id}}",
                            "valueLabel": "",
                            "propLabel": "Batch ID"
                          },
                          {
                            "prop": "index",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:index}}",
                            "valueLabel": "",
                            "propLabel": "Index"
                          },
                          {
                            "prop": "itemData",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData}}",
                            "valueLabel": "",
                            "propLabel": "Item Data"
                          },
                          {
                            "prop": "parent_trx_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_no}}",
                            "valueLabel": "",
                            "propLabel": "Parent Trx No"
                          },
                          {
                            "prop": "isMovingInv",
                            "operator": "",
                            "valueType": "value",
                            "value": 1,
                            "valueLabel": "",
                            "propLabel": "Moving Inventory?"
                          },
                          {
                            "prop": "doc_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_date}}",
                            "valueLabel": "",
                            "propLabel": "Doc Date"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  },
                  {
                    "id": "if_nbItpgb4",
                    "type": "if",
                    "data": {
                      "title": "IF subtractInventory Failed",
                      "isValidator": true,
                      "nodeName": "IF subtractInventory Failed",
                      "name": "IF subtractInventory Failed",
                      "condition_type": "Expression",
                      "filter": {
                        "list": [
                          {
                            "id": 1736695973613,
                            "parentId": 1736695973612,
                            "isTop": true,
                            "prop": "",
                            "operator": "",
                            "valueType": "",
                            "value": "",
                            "type": "leaf",
                            "level": 1
                          }
                        ]
                      },
                      "expression": {
                        "type": "javascript",
                        "code": "'{{node:workflow_node_DWZUziMB.data.code}}' == '400'"
                      }
                    },
                    "blocks": [
                      {
                        "id": "ifBlock_HNyyp54Q",
                        "type": "ifBlock",
                        "data": { "title": "true" },
                        "blocks": [
                          {
                            "id": "return_node_5YDIVvFw",
                            "type": "return-node",
                            "data": {
                              "return_data": {},
                              "status_code": 200,
                              "title": "Return Data",
                              "isValidator": true,
                              "nodeName": "Return Data",
                              "name": "Return Data",
                              "response_value": {
                                "list": [
                                  {
                                    "prop": "code",
                                    "propLabel": "code",
                                    "operator": "",
                                    "operatorLabel": "",
                                    "valueType": "value",
                                    "valueTypeLabel": "",
                                    "value": "400",
                                    "valueLabel": ""
                                  },
                                  {
                                    "prop": "message",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{node:workflow_node_DWZUziMB.data.errorMessage}}",
                                    "valueLabel": "",
                                    "propLabel": "message"
                                  }
                                ]
                              },
                              "return_raw_data": 0
                            },
                            "blocks": []
                          }
                        ]
                      },
                      {
                        "id": "ifBlock_SV3Xi5wa",
                        "type": "ifBlock",
                        "data": { "title": "false" },
                        "blocks": []
                      }
                    ]
                  },
                  {
                    "id": "workflow_node_xCky2T47",
                    "type": "workflow-node",
                    "data": {
                      "workflow_id": "",
                      "workflow_name": "",
                      "input_params": {},
                      "title": "Add Inventory Workflow",
                      "isValidator": true,
                      "nodeName": "Add Inventory Workflow",
                      "name": "Add Inventory Workflow",
                      "workflow": {
                        "source": "ADD_INVENTORY:Workflow:2012005532688723970",
                        "rules": {
                          "collectionId": "2012005532688723970",
                          "list": [
                            {
                              "id": 1723795236686,
                              "parentId": 1723795236685,
                              "isTop": true,
                              "prop": "",
                              "operator": "",
                              "valueType": "",
                              "value": "",
                              "type": "leaf",
                              "level": 1
                            }
                          ]
                        }
                      },
                      "remote": true,
                      "remoteType": "innerdatasource",
                      "body_params": {
                        "list": [
                          {
                            "prop": "plant_id",
                            "propLabel": "Plant ID",
                            "operator": "",
                            "operatorLabel": "",
                            "valueType": "field",
                            "valueTypeLabel": "",
                            "value": "{{workflowparams:plant_id}}",
                            "valueLabel": ""
                          },
                          {
                            "prop": "organization_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:organization_id}}",
                            "valueLabel": "",
                            "propLabel": "Organization ID"
                          },
                          {
                            "prop": "material_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_id}}",
                            "valueLabel": "",
                            "propLabel": "Material ID"
                          },
                          {
                            "prop": "quantity",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:quantity}}",
                            "valueLabel": "",
                            "propLabel": "Quantity"
                          },
                          {
                            "prop": "material_uom",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_uom}}",
                            "valueLabel": "",
                            "propLabel": "UOM"
                          },
                          {
                            "prop": "unit_price",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:workflow_node_NF1z0xpf.data.unit_price}}",
                            "valueLabel": "",
                            "propLabel": "Unit Price"
                          },
                          {
                            "prop": "transaction_type",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:transaction_type}}",
                            "valueLabel": "",
                            "propLabel": "Transaction Type"
                          },
                          {
                            "prop": "trx_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_no}}",
                            "valueLabel": "",
                            "propLabel": "Trx No"
                          },
                          {
                            "prop": "parent_trx_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_no}}",
                            "valueLabel": "",
                            "propLabel": "Parent Trx No"
                          },
                          {
                            "prop": "inventory_category",
                            "operator": "",
                            "valueType": "value",
                            "value": "Reserved",
                            "valueLabel": "",
                            "propLabel": "Inventory Category"
                          },
                          {
                            "prop": "location_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:location_id}}",
                            "valueLabel": "",
                            "propLabel": "Location ID"
                          },
                          {
                            "prop": "batch_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:batch_id}}",
                            "valueLabel": "",
                            "propLabel": "Batch ID"
                          },
                          {
                            "prop": "index",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:index}}",
                            "valueLabel": "",
                            "propLabel": "Index"
                          },
                          {
                            "prop": "itemData",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData}}",
                            "valueLabel": "",
                            "propLabel": "Item Data"
                          },
                          {
                            "prop": "isMovingInv",
                            "operator": "",
                            "valueType": "value",
                            "value": 1,
                            "valueLabel": "",
                            "propLabel": "Moving Inventory?"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  },
                  {
                    "id": "if_tVJA9dQG",
                    "type": "if",
                    "data": {
                      "title": "IF addInventory Failed",
                      "isValidator": true,
                      "nodeName": "IF addInventory Failed",
                      "name": "IF addInventory Failed",
                      "condition_type": "Expression",
                      "expression": {
                        "type": "javascript",
                        "code": "'{{node:workflow_node_xCky2T47.data.code}}' == '400'"
                      },
                      "filter": {
                        "list": [
                          {
                            "id": 1736695973613,
                            "parentId": 1736695973612,
                            "isTop": true,
                            "prop": "",
                            "operator": "",
                            "valueType": "",
                            "value": "",
                            "type": "leaf",
                            "level": 1
                          }
                        ]
                      }
                    },
                    "blocks": [
                      {
                        "id": "ifBlock_8gAHM8n8",
                        "type": "ifBlock",
                        "data": { "title": "true" },
                        "blocks": [
                          {
                            "id": "return_node_rKRKXPr8",
                            "type": "return-node",
                            "data": {
                              "return_data": {},
                              "status_code": 200,
                              "title": "Return Data",
                              "isValidator": true,
                              "nodeName": "Return Data",
                              "name": "Return Data",
                              "response_value": {
                                "list": [
                                  {
                                    "prop": "code",
                                    "propLabel": "code",
                                    "operator": "",
                                    "operatorLabel": "",
                                    "valueType": "value",
                                    "valueTypeLabel": "",
                                    "value": "400",
                                    "valueLabel": ""
                                  },
                                  {
                                    "prop": "message",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{node:workflow_node_xCky2T47.data.errorMessage}}",
                                    "valueLabel": "",
                                    "propLabel": "message"
                                  }
                                ]
                              },
                              "return_raw_data": 0
                            },
                            "blocks": []
                          }
                        ]
                      },
                      {
                        "id": "ifBlock_i5mbZBlT",
                        "type": "ifBlock",
                        "data": { "title": "false" },
                        "blocks": []
                      }
                    ]
                  }
                ]
              },
              {
                "id": "condition_or_item_yllLvbvR",
                "type": "condition-or-node-item",
                "data": {
                  "title": "Production Receipt",
                  "filter": {
                    "list": [
                      {
                        "id": 1769566231725,
                        "parentId": 1769566231724,
                        "isTop": true,
                        "prop": "",
                        "operator": "",
                        "valueType": "",
                        "value": "",
                        "type": "leaf",
                        "level": 1
                      }
                    ]
                  },
                  "expression": {
                    "code": "'{{workflowparams:doc_type}}' == 'Production Receipt'",
                    "type": "javascript"
                  },
                  "displayContent": "sdk.form.setCondition",
                  "__index": 2,
                  "isDefault": false,
                  "isValidator": true,
                  "nodeName": "Production Receipt",
                  "name": "Production Receipt",
                  "condition_type": "Expression"
                },
                "blocks": [
                  {
                    "id": "add_node_FMva4OAM",
                    "type": "add-node",
                    "data": {
                      "table_id": {
                        "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                        "rules": {
                          "collectionId": "1935880014687440897",
                          "list": [
                            {
                              "id": 1769566749982,
                              "parentId": 1769566749981,
                              "isTop": true,
                              "prop": "",
                              "operator": "",
                              "valueType": "",
                              "value": "",
                              "type": "leaf",
                              "level": 1
                            }
                          ]
                        }
                      },
                      "fields": [],
                      "title": "Add Reserved Table",
                      "isValidator": true,
                      "nodeName": "Add Reserved Table",
                      "name": "Add Reserved Table",
                      "props": {
                        "modelName": "",
                        "list": [
                          {
                            "prop": "doc_type",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_type}}",
                            "operator": "",
                            "valueLabel": "",
                            "propLabel": "Document Type"
                          },
                          {
                            "prop": "status",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:status}}",
                            "valueLabel": "",
                            "propLabel": "Status"
                          },
                          {
                            "prop": "parent_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent ID"
                          },
                          {
                            "prop": "parent_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent Line ID"
                          },
                          {
                            "prop": "parent_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_no}}",
                            "valueLabel": "",
                            "propLabel": "Parent Number"
                          },
                          {
                            "prop": "doc_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_no}}",
                            "valueLabel": "",
                            "propLabel": "Document Number"
                          },
                          {
                            "prop": "doc_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_id}}",
                            "valueLabel": "",
                            "propLabel": "Document ID"
                          },
                          {
                            "prop": "doc_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Document Line ID"
                          },
                          {
                            "prop": "material_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_id}}",
                            "valueLabel": "",
                            "propLabel": "Item ID"
                          },
                          {
                            "prop": "item_code",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_code}}",
                            "valueLabel": "",
                            "propLabel": "Item Code"
                          },
                          {
                            "prop": "item_name",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_name}}",
                            "valueLabel": "",
                            "propLabel": "Item Name"
                          },
                          {
                            "prop": "item_desc",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_desc}}",
                            "valueLabel": "",
                            "propLabel": "Item Description"
                          },
                          {
                            "prop": "batch_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:batch_id}}",
                            "valueLabel": "",
                            "propLabel": "Batch ID"
                          },
                          {
                            "prop": "bin_location",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:location_id}}",
                            "valueLabel": "",
                            "propLabel": "Bin Location"
                          },
                          {
                            "prop": "item_uom",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_uom}}",
                            "valueLabel": "",
                            "propLabel": "UOM"
                          },
                          {
                            "prop": "reserved_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:quantity}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Quantity"
                          },
                          {
                            "prop": "delivered_qty",
                            "operator": "",
                            "valueType": "value",
                            "value": 0,
                            "valueLabel": "",
                            "propLabel": "Delivered Quantity"
                          },
                          {
                            "prop": "open_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:quantity}}",
                            "valueLabel": "",
                            "propLabel": "Open Quantity"
                          },
                          {
                            "prop": "reserved_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_date}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Date"
                          },
                          {
                            "prop": "line_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:index}}",
                            "valueLabel": "",
                            "propLabel": "Line No"
                          },
                          {
                            "prop": "plant_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:plant_id}}",
                            "valueLabel": "",
                            "propLabel": "Plant ID"
                          },
                          {
                            "prop": "organization_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:organization_id}}",
                            "valueLabel": "",
                            "propLabel": "Organization ID"
                          },
                          {
                            "prop": "remark",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:remark}}",
                            "valueLabel": "",
                            "propLabel": "Remark"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  },
                  {
                    "id": "workflow_node_bvHNt6Ve",
                    "type": "workflow-node",
                    "data": {
                      "workflow_id": "",
                      "workflow_name": "",
                      "input_params": {},
                      "title": "Add Inventory Workflow",
                      "isValidator": true,
                      "nodeName": "Add Inventory Workflow",
                      "name": "Add Inventory Workflow",
                      "workflow": {
                        "source": "ADD_INVENTORY:Workflow:2012005532688723970",
                        "rules": {
                          "collectionId": "2012005532688723970",
                          "list": [
                            {
                              "id": 1723795236686,
                              "parentId": 1723795236685,
                              "isTop": true,
                              "prop": "",
                              "operator": "",
                              "valueType": "",
                              "value": "",
                              "type": "leaf",
                              "level": 1
                            }
                          ]
                        }
                      },
                      "remote": true,
                      "remoteType": "innerdatasource",
                      "body_params": {
                        "list": [
                          {
                            "prop": "plant_id",
                            "propLabel": "Plant ID",
                            "operator": "",
                            "operatorLabel": "",
                            "valueType": "field",
                            "valueTypeLabel": "",
                            "value": "{{workflowparams:plant_id}}",
                            "valueLabel": ""
                          },
                          {
                            "prop": "organization_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:organization_id}}",
                            "valueLabel": "",
                            "propLabel": "Organization ID"
                          },
                          {
                            "prop": "material_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_id}}",
                            "valueLabel": "",
                            "propLabel": "Material ID"
                          },
                          {
                            "prop": "quantity",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:quantity}}",
                            "valueLabel": "",
                            "propLabel": "Quantity"
                          },
                          {
                            "prop": "material_uom",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_uom}}",
                            "valueLabel": "",
                            "propLabel": "UOM"
                          },
                          {
                            "prop": "unit_price",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:workflow_node_NF1z0xpf.data.unit_price}}",
                            "valueLabel": "",
                            "propLabel": "Unit Price"
                          },
                          {
                            "prop": "transaction_type",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:transaction_type}}",
                            "valueLabel": "",
                            "propLabel": "Transaction Type"
                          },
                          {
                            "prop": "trx_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_no}}",
                            "valueLabel": "",
                            "propLabel": "Trx No"
                          },
                          {
                            "prop": "parent_trx_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_no}}",
                            "valueLabel": "",
                            "propLabel": "Parent Trx No"
                          },
                          {
                            "prop": "inventory_category",
                            "operator": "",
                            "valueType": "value",
                            "value": "Reserved",
                            "valueLabel": "",
                            "propLabel": "Inventory Category"
                          },
                          {
                            "prop": "location_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:location_id}}",
                            "valueLabel": "",
                            "propLabel": "Location ID"
                          },
                          {
                            "prop": "index",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:index}}",
                            "valueLabel": "",
                            "propLabel": "Index"
                          },
                          {
                            "prop": "itemData",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData}}",
                            "valueLabel": "",
                            "propLabel": "Item Data"
                          },
                          {
                            "prop": "isMovingInv",
                            "operator": "",
                            "valueType": "value",
                            "value": 0,
                            "valueLabel": "",
                            "propLabel": "Moving Inventory?"
                          },
                          {
                            "prop": "doc_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_date}}",
                            "valueLabel": "",
                            "propLabel": "Doc Date"
                          },
                          {
                            "prop": "manufacturing_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:manufacturing_date}}",
                            "valueLabel": "",
                            "propLabel": "Manufacturing Date"
                          },
                          {
                            "prop": "expired_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:expired_date}}",
                            "valueLabel": "",
                            "propLabel": "Expired Date"
                          },
                          {
                            "prop": "remark",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:remark}}",
                            "valueLabel": "",
                            "propLabel": "Remark"
                          },
                          {
                            "prop": "batch_number",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:batch_no}}",
                            "valueLabel": "",
                            "propLabel": "Batch Number"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  },
                  {
                    "id": "if_BTg9gCVi",
                    "type": "if",
                    "data": {
                      "title": "IF addInventory Failed",
                      "isValidator": true,
                      "nodeName": "IF addInventory Failed",
                      "name": "IF addInventory Failed",
                      "condition_type": "Expression",
                      "expression": {
                        "type": "javascript",
                        "code": "'{{node:workflow_node_bvHNt6Ve.data.code}}' == '400'"
                      },
                      "filter": {
                        "list": [
                          {
                            "id": 1736695973613,
                            "parentId": 1736695973612,
                            "isTop": true,
                            "prop": "",
                            "operator": "",
                            "valueType": "",
                            "value": "",
                            "type": "leaf",
                            "level": 1
                          }
                        ]
                      }
                    },
                    "blocks": [
                      {
                        "id": "ifBlock_HljHny9l",
                        "type": "ifBlock",
                        "data": { "title": "true" },
                        "blocks": [
                          {
                            "id": "return_node_di15cos0",
                            "type": "return-node",
                            "data": {
                              "return_data": {},
                              "status_code": 200,
                              "title": "Return Data",
                              "isValidator": true,
                              "nodeName": "Return Data",
                              "name": "Return Data",
                              "response_value": {
                                "list": [
                                  {
                                    "prop": "code",
                                    "propLabel": "code",
                                    "operator": "",
                                    "operatorLabel": "",
                                    "valueType": "value",
                                    "valueTypeLabel": "",
                                    "value": "400",
                                    "valueLabel": ""
                                  },
                                  {
                                    "prop": "message",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{node:workflow_node_bvHNt6Ve.data.errorMessage}}",
                                    "valueLabel": "",
                                    "propLabel": "message"
                                  }
                                ]
                              },
                              "return_raw_data": 0
                            },
                            "blocks": []
                          }
                        ]
                      },
                      {
                        "id": "ifBlock_3JiPRFu8",
                        "type": "ifBlock",
                        "data": { "title": "false" },
                        "blocks": []
                      }
                    ]
                  }
                ]
              },
              {
                "id": "condition_or_node_item_EoyVDf78",
                "type": "condition-or-node-item",
                "data": {
                  "title": "Invalid Category",
                  "isDefault": true,
                  "filter": { "list": [] },
                  "expression": { "code": "" },
                  "displayContent": "sdk.form.otherCondition"
                },
                "blocks": [
                  {
                    "id": "return_node_ERPU4pRt",
                    "type": "return-node",
                    "data": {
                      "return_data": {},
                      "status_code": 200,
                      "title": "Return Data",
                      "isValidator": true,
                      "nodeName": "Return Data",
                      "name": "Return Data",
                      "response_value": {
                        "list": [
                          {
                            "prop": "code",
                            "propLabel": "code",
                            "operator": "",
                            "operatorLabel": "",
                            "valueType": "value",
                            "valueTypeLabel": "",
                            "value": "400",
                            "valueLabel": ""
                          },
                          {
                            "prop": "message",
                            "operator": "",
                            "valueType": "value",
                            "value": "Invalid Document Type for Pending status",
                            "valueLabel": "",
                            "propLabel": "message"
                          }
                        ]
                      },
                      "return_raw_data": 0
                    },
                    "blocks": []
                  }
                ]
              }
            ]
          },
          {
            "id": "return_node_qi7sqvOV",
            "type": "return-node",
            "data": {
              "return_data": {},
              "status_code": 200,
              "title": "Return Data",
              "isValidator": true,
              "nodeName": "Return Data",
              "name": "Return Data",
              "response_value": {
                "list": [
                  {
                    "prop": "code",
                    "propLabel": "code",
                    "operator": "",
                    "operatorLabel": "",
                    "valueType": "value",
                    "valueTypeLabel": "",
                    "value": "200",
                    "valueLabel": ""
                  },
                  {
                    "prop": "message",
                    "operator": "",
                    "valueType": "value",
                    "value": "Pending recorded successfully",
                    "valueLabel": "",
                    "propLabel": "message"
                  }
                ]
              },
              "return_raw_data": 0
            },
            "blocks": []
          }
        ]
      },
      {
        "id": "condition_or_item_wywXEBEu",
        "type": "condition-or-node-item",
        "data": {
          "title": "Allocated",
          "filter": {
            "list": [
              {
                "id": 1769566048176,
                "parentId": 1769566048175,
                "isTop": true,
                "prop": "",
                "operator": "",
                "valueType": "",
                "value": "",
                "type": "leaf",
                "level": 1
              }
            ]
          },
          "expression": {
            "code": "'{{workflowparams:status}}' == 'Allocated'",
            "type": "javascript"
          },
          "displayContent": "sdk.form.setCondition",
          "__index": 2,
          "isDefault": false,
          "isValidator": true,
          "nodeName": "Allocated",
          "name": "Allocated",
          "condition_type": "Expression"
        },
        "blocks": [
          {
            "id": "search_node_IJAcucMA",
            "type": "search-node",
            "data": {
              "table_id": {
                "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                "rules": {
                  "collectionId": "1935880014687440897",
                  "list": [
                    {
                      "id": 1769567718496,
                      "parentId": 1769567718497,
                      "isTop": true,
                      "type": "branch",
                      "operator": "all",
                      "prop": "",
                      "valueType": "",
                      "value": "",
                      "level": 1,
                      "children": [
                        {
                          "id": 1769567718489,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "plant_id",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:plant_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Plant ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718498,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "organization_id",
                          "operator": "equal",
                          "valueType": "field",
                          "value": "{{workflowparams:organization_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Organization ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718499,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "material_id",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:material_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Item ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718500,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "bin_location",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:location_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Bin Location",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718501,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "batch_id",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:batch_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Batch ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718502,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "status",
                          "operator": "equal",
                          "valueType": "value",
                          "value": "Pending",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Status",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718503,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "parent_id",
                          "operator": "equal",
                          "valueType": "field",
                          "value": "{{workflowparams:parent_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Parent ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718504,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "parent_line_id",
                          "operator": "equal",
                          "valueType": "field",
                          "value": "{{workflowparams:parent_line_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Parent Line ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        }
                      ]
                    }
                  ]
                }
              },
              "condition": {},
              "limit": 100,
              "title": "Get Reserved Table",
              "isValidator": true,
              "nodeName": "Get Reserved Table",
              "name": "Get Reserved Table"
            },
            "blocks": []
          },
          {
            "id": "code_node_Njvhx8FJ",
            "type": "code-node",
            "data": {
              "language": "javascript",
              "code": "",
              "timeout": 30000,
              "title": "Allocated Record Preparation",
              "isValidator": true,
              "nodeName": "Allocated Record Preparation",
              "name": "Allocated Record Preparation",
              "script": {
                "type": "javascript",
                "code": "// ============================================================================\n// RESERVED TABLE ALLOCATION LOGIC\n// Handles both initial allocation (GD Created) and re-allocation (GD Edit)\n// ============================================================================\n\n// Extract workflow parameters\nconst existingData = {{node:search_node_IJAcucMA.data.data}};\nconst oldAllocatedData = {{workflowparams:oldAllocatedData}} || [];\nconst quantity = {{workflowparams:quantity}};\nconst parentId = {{workflowparams:parent_id}};\nconst parentLineId = {{workflowparams:parent_line_id}};\nconst parentNo = {{workflowparams:parent_no}};\nconst docId = {{workflowparams:doc_id}};\nconst docLineId = {{workflowparams:doc_line_id}};\nconst docNo = {{workflowparams:doc_no}};\nconst materialId = {{workflowparams:material_id}};\nconst itemData = {{workflowparams:itemData}};\nconst batchId = {{workflowparams:batch_id}};\nconst locationId = {{workflowparams:location_id}};\nconst materialUom = {{workflowparams:material_uom}};\nconst docDate = {{workflowparams:doc_date}};\nconst index = {{workflowparams:index}};\nconst plantId = {{workflowparams:plant_id}};\nconst organizationId = {{workflowparams:organization_id}};\nconst remark = {{workflowparams:remark}};\n\n// ============================================================================\n// STEP 1: Determine if this is new allocation or re-allocation\n// ============================================================================\n\n// Find old allocated records matching this specific temp_data item\nconst matchedOldRecords = oldAllocatedData.filter(\n  (record) =>\n    record.doc_line_id === docLineId &&\n    record.material_id === materialId &&\n    record.batch_id === batchId &&\n    record.bin_location === locationId &&\n    record.status === \"Allocated\" &&\n    record.target_reserved_id === docId,\n);\n\n// ============================================================================\n// BRANCH: RE-ALLOCATION PATH (Edit existing GD Created)\n// ============================================================================\n\nif (matchedOldRecords.length > 0) {\n  // Calculate old allocated quantity\n  const oldQty = matchedOldRecords.reduce(\n    (sum, r) => sum + (r.reserved_qty || 0),\n    0,\n  );\n  const newQty = quantity;\n  const netChange = newQty - oldQty;\n\n  // -------------------------------------------------------------------------\n  // Case 1: No change needed\n  // -------------------------------------------------------------------------\n  if (netChange === 0) {\n    return {\n      code: \"200\",\n      recordsToUpdate: [],\n      recordToCreate: null,\n      message: \"No change - quantities match\",\n    };\n  }\n\n  // -------------------------------------------------------------------------\n  // Case 2: Quantity decreased - Release allocation\n  // -------------------------------------------------------------------------\n  if (netChange < 0) {\n    const qtyToRelease = Math.abs(netChange);\n    let remainingQtyToRelease = qtyToRelease;\n    const recordsToUpdate = [];\n    let recordToCreate = null;\n\n    // Release from matched old records (FIFO order)\n    for (const oldRecord of matchedOldRecords) {\n      if (remainingQtyToRelease <= 0) break;\n\n      const releaseFromThisRecord = Math.min(\n        oldRecord.reserved_qty,\n        remainingQtyToRelease,\n      );\n\n      if (releaseFromThisRecord === oldRecord.reserved_qty) {\n        // Fully release this record - convert to Pending\n        recordsToUpdate.push({\n          ...oldRecord,\n          status: \"Pending\",\n          target_reserved_id: null,\n        });\n      } else {\n        // Partial release - split the record\n        // Keep allocated portion (update existing record)\n        recordsToUpdate.push({\n          ...oldRecord,\n          reserved_qty: oldRecord.reserved_qty - releaseFromThisRecord,\n          open_qty: oldRecord.reserved_qty - releaseFromThisRecord,\n          status: \"Allocated\",\n          target_reserved_id: docId,\n        });\n\n        // Create pending for released portion\n        const { _id, ...recordWithoutId } = oldRecord;\n        recordToCreate = {\n          ...recordWithoutId,\n          reserved_qty: releaseFromThisRecord,\n          open_qty: releaseFromThisRecord,\n          status: \"Pending\",\n          target_reserved_id: null,\n        };\n      }\n\n      remainingQtyToRelease -= releaseFromThisRecord;\n    }\n\n    return {\n      code: \"200\",\n      recordsToUpdate,\n      recordToCreate,\n      message: \"Allocation released (decreased quantity)\",\n    };\n  }\n\n  // -------------------------------------------------------------------------\n  // Case 3: Quantity increased - Allocate additional\n  // -------------------------------------------------------------------------\n  if (netChange > 0) {\n    // Use the same allocation logic as new allocation, but for the ADDITIONAL quantity\n    const additionalQty = netChange;\n\n    // Filter existing pending data (exclude already allocated)\n    const pendingSOData =\n      existingData.filter(\n        (item) => item.status === \"Pending\" && item.doc_type === \"Sales Order\",\n      ) || [];\n\n    const pendingProdReceiptData =\n      existingData.filter(\n        (item) =>\n          item.status === \"Pending\" && item.doc_type === \"Production Receipt\",\n      ) || [];\n\n    // Validate: Only one pending record per source type allowed\n    if (pendingSOData.length > 1) {\n      return {\n        code: \"400\",\n        message: \"Multiple pending sales orders found\",\n      };\n    }\n\n    if (pendingProdReceiptData.length > 1) {\n      return {\n        code: \"400\",\n        message: \"Multiple pending production receipts found\",\n      };\n    }\n\n    const salesOrderOpenQty =\n      pendingSOData.length > 0 ? pendingSOData[0].open_qty : 0;\n    const productionReceiptOpenQty =\n      pendingProdReceiptData.length > 0\n        ? pendingProdReceiptData[0].open_qty\n        : 0;\n\n    let remainingQtyToAllocate = additionalQty;\n    const recordsToUpdate = [];\n    let recordToCreate = null;\n\n    // PRIORITY 1: Allocate from Production Receipt\n    if (pendingProdReceiptData.length > 0 && remainingQtyToAllocate > 0) {\n      const allocateQty = Math.min(\n        productionReceiptOpenQty,\n        remainingQtyToAllocate,\n      );\n\n      if (allocateQty === productionReceiptOpenQty) {\n        recordsToUpdate.push({\n          ...pendingProdReceiptData[0],\n          status: \"Allocated\",\n          target_reserved_id: docId,\n        });\n      } else {\n        recordsToUpdate.push({\n          ...pendingProdReceiptData[0],\n          reserved_qty: allocateQty,\n          open_qty: allocateQty,\n          status: \"Allocated\",\n          target_reserved_id: docId,\n        });\n\n        const { _id, ...prodReceiptWithoutId } = pendingProdReceiptData[0];\n        recordToCreate = {\n          ...prodReceiptWithoutId,\n          reserved_qty: productionReceiptOpenQty - allocateQty,\n          open_qty: productionReceiptOpenQty - allocateQty,\n          status: \"Pending\",\n          source_reserved_id: docId,\n          target_reserved_id: null,\n        };\n      }\n\n      remainingQtyToAllocate -= allocateQty;\n    }\n\n    // PRIORITY 2: Allocate from Sales Order\n    if (pendingSOData.length > 0 && remainingQtyToAllocate > 0) {\n      const allocateQty = Math.min(salesOrderOpenQty, remainingQtyToAllocate);\n\n      if (allocateQty === salesOrderOpenQty) {\n        recordsToUpdate.push({\n          ...pendingSOData[0],\n          status: \"Allocated\",\n          target_reserved_id: docId,\n        });\n      } else {\n        recordsToUpdate.push({\n          ...pendingSOData[0],\n          reserved_qty: allocateQty,\n          open_qty: allocateQty,\n          status: \"Allocated\",\n          target_reserved_id: docId,\n        });\n\n        const { _id, ...soWithoutId } = pendingSOData[0];\n        recordToCreate = {\n          ...soWithoutId,\n          reserved_qty: salesOrderOpenQty - allocateQty,\n          open_qty: salesOrderOpenQty - allocateQty,\n          status: \"Pending\",\n          source_reserved_id: docId,\n          target_reserved_id: null,\n        };\n      }\n\n      remainingQtyToAllocate -= allocateQty;\n    }\n\n    // Shortfall: Direct allocation\n    if (remainingQtyToAllocate > 0) {\n      recordToCreate = {\n        doc_type: \"Good Delivery\",\n        status: \"Allocated\",\n        source_reserved_id: null,\n        parent_id: parentId,\n        parent_line_id: parentLineId,\n        parent_no: parentNo,\n        doc_no: docNo,\n        doc_id: docId,\n        doc_line_id: docLineId,\n        material_id: materialId,\n        item_code: itemData.material_code,\n        item_name: itemData.material_name,\n        item_desc: itemData.material_desc,\n        batch_id: batchId,\n        bin_location: locationId,\n        item_uom: materialUom,\n        reserved_qty: remainingQtyToAllocate,\n        delivered_qty: 0,\n        open_qty: remainingQtyToAllocate,\n        reserved_date: docDate,\n        line_no: index,\n        plant_id: plantId,\n        organization_id: organizationId,\n        remark: remark,\n        target_reserved_id: docId,\n      };\n    }\n\n    return {\n      code: \"200\",\n      recordsToUpdate,\n      recordToCreate,\n      message: \"Additional allocation successful (increased quantity)\",\n    };\n  }\n}\n\n// ============================================================================\n// BRANCH: NEW ALLOCATION PATH (Initial GD Created)\n// ============================================================================\n\n// Filter existing pending data\nconst pendingSOData =\n  existingData.filter(\n    (item) => item.status === \"Pending\" && item.doc_type === \"Sales Order\",\n  ) || [];\n\nconst pendingProdReceiptData =\n  existingData.filter(\n    (item) =>\n      item.status === \"Pending\" && item.doc_type === \"Production Receipt\",\n  ) || [];\n\n// Validate: Only one pending record per source type allowed\nif (pendingSOData.length > 1) {\n  return {\n    code: \"400\",\n    message: \"Multiple pending sales orders found\",\n  };\n}\n\nif (pendingProdReceiptData.length > 1) {\n  return {\n    code: \"400\",\n    message: \"Multiple pending production receipts found\",\n  };\n}\n\n// Safe extraction of open quantities\nconst salesOrderOpenQty =\n  pendingSOData.length > 0 ? pendingSOData[0].open_qty : 0;\nconst productionReceiptOpenQty =\n  pendingProdReceiptData.length > 0 ? pendingProdReceiptData[0].open_qty : 0;\n\nlet remainingQtyToAllocate = quantity;\nconst recordsToUpdate = [];\nlet recordToCreate = null;\n\n// PRIORITY 1: Allocate from Production Receipt\nif (pendingProdReceiptData.length > 0 && remainingQtyToAllocate > 0) {\n  const allocateQty = Math.min(\n    productionReceiptOpenQty,\n    remainingQtyToAllocate,\n  );\n\n  if (allocateQty === productionReceiptOpenQty) {\n    recordsToUpdate.push({\n      ...pendingProdReceiptData[0],\n      status: \"Allocated\",\n      target_reserved_id: docId,\n    });\n  } else {\n    recordsToUpdate.push({\n      ...pendingProdReceiptData[0],\n      reserved_qty: allocateQty,\n      open_qty: allocateQty,\n      status: \"Allocated\",\n      target_reserved_id: docId,\n    });\n\n    const { _id, ...prodReceiptWithoutId } = pendingProdReceiptData[0];\n    recordToCreate = {\n      ...prodReceiptWithoutId,\n      reserved_qty: productionReceiptOpenQty - allocateQty,\n      open_qty: productionReceiptOpenQty - allocateQty,\n      status: \"Pending\",\n      source_reserved_id: docId,\n      target_reserved_id: null,\n    };\n  }\n\n  remainingQtyToAllocate -= allocateQty;\n}\n\n// PRIORITY 2: Allocate from Sales Order\nif (pendingSOData.length > 0 && remainingQtyToAllocate > 0) {\n  const allocateQty = Math.min(salesOrderOpenQty, remainingQtyToAllocate);\n\n  if (allocateQty === salesOrderOpenQty) {\n    recordsToUpdate.push({\n      ...pendingSOData[0],\n      status: \"Allocated\",\n      target_reserved_id: docId,\n    });\n  } else {\n    recordsToUpdate.push({\n      ...pendingSOData[0],\n      reserved_qty: allocateQty,\n      open_qty: allocateQty,\n      status: \"Allocated\",\n      target_reserved_id: docId,\n    });\n\n    const { _id, ...soWithoutId } = pendingSOData[0];\n    recordToCreate = {\n      ...soWithoutId,\n      reserved_qty: salesOrderOpenQty - allocateQty,\n      open_qty: salesOrderOpenQty - allocateQty,\n      status: \"Pending\",\n      source_reserved_id: docId,\n      target_reserved_id: null,\n    };\n  }\n\n  remainingQtyToAllocate -= allocateQty;\n}\n\n// Shortfall: Direct allocation from unrestricted inventory\nif (remainingQtyToAllocate > 0) {\n  recordToCreate = {\n    doc_type: \"Good Delivery\",\n    status: \"Allocated\",\n    source_reserved_id: null,\n    parent_id: parentId,\n    parent_line_id: parentLineId,\n    parent_no: parentNo,\n    doc_no: docNo,\n    doc_id: docId,\n    doc_line_id: docLineId,\n    material_id: materialId,\n    item_code: itemData.material_code,\n    item_name: itemData.material_name,\n    item_desc: itemData.material_desc,\n    batch_id: batchId,\n    bin_location: locationId,\n    item_uom: materialUom,\n    reserved_qty: remainingQtyToAllocate,\n    delivered_qty: 0,\n    open_qty: remainingQtyToAllocate,\n    reserved_date: docDate,\n    line_no: index,\n    plant_id: plantId,\n    organization_id: organizationId,\n    remark: remark,\n    target_reserved_id: docId,\n  };\n}\n\nreturn {\n  code: \"200\",\n  recordsToUpdate: recordsToUpdate,\n  recordToCreate: recordToCreate,\n  message: \"Initial allocation successful\",\n};\n"
              },
              "response_json": [
                {
                  "key": "okro9jfm",
                  "name": "code",
                  "title": "code",
                  "description": "",
                  "bsonType": "string",
                  "isExpand": false
                },
                {
                  "key": "1ecx9wxp",
                  "name": "recordsToUpdate",
                  "title": "recordsToUpdate",
                  "description": "",
                  "bsonType": "array",
                  "isExpand": true,
                  "children": [
                    {
                      "key": "po5binpe",
                      "name": "items",
                      "title": "",
                      "description": "",
                      "bsonType": "any",
                      "isExpand": false,
                      "isArrayItem": true,
                      "children": []
                    }
                  ]
                },
                {
                  "key": "xjbtep69",
                  "name": "recordToCreate",
                  "title": "recordsToCreate",
                  "description": "",
                  "bsonType": "any",
                  "isExpand": false,
                  "children": []
                },
                {
                  "key": "ii7sab6f",
                  "name": "message",
                  "title": "message",
                  "description": "",
                  "bsonType": "string",
                  "isExpand": false
                }
              ]
            },
            "blocks": []
          },
          {
            "id": "if_cDl6qe2i",
            "type": "if",
            "data": {
              "title": "Error Handling",
              "isValidator": true,
              "nodeName": "Error Handling",
              "name": "Error Handling",
              "condition_type": "ConditionRule",
              "expression": { "type": "javascript", "code": "" },
              "filter": {
                "list": [
                  {
                    "id": 1736695973613,
                    "parentId": 1736695973612,
                    "isTop": true,
                    "prop": "node.code_node_Njvhx8FJ.data.code",
                    "operator": "equal",
                    "valueType": "value",
                    "value": "400",
                    "type": "leaf",
                    "level": 1,
                    "propLabel": "code",
                    "valueLabel": "",
                    "operatorLabel": "Equal"
                  }
                ]
              }
            },
            "blocks": [
              {
                "id": "if_block_Vjl33jA5",
                "type": "ifBlock",
                "data": { "title": "true" },
                "blocks": [
                  {
                    "id": "return_node_EAe20bpt",
                    "type": "return-node",
                    "data": {
                      "return_data": {},
                      "status_code": 200,
                      "title": "Return Data",
                      "isValidator": true,
                      "nodeName": "Return Data",
                      "name": "Return Data",
                      "response_value": {
                        "list": [
                          {
                            "prop": "code",
                            "propLabel": "code",
                            "operator": "",
                            "operatorLabel": "",
                            "valueType": "field",
                            "valueTypeLabel": "",
                            "value": "{{node:code_node_Njvhx8FJ.data.code}}",
                            "valueLabel": ""
                          },
                          {
                            "prop": "message",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.message}}",
                            "valueLabel": "",
                            "propLabel": "message"
                          }
                        ]
                      },
                      "return_raw_data": 0
                    },
                    "blocks": []
                  }
                ]
              },
              {
                "id": "if_block_SBHJS14I",
                "type": "ifBlock",
                "data": { "title": "false" },
                "blocks": []
              }
            ]
          },
          {
            "id": "if_W2LT0S1r",
            "type": "if",
            "data": {
              "title": "IF recordsToUpdate",
              "isValidator": true,
              "nodeName": "IF recordsToUpdate",
              "name": "IF recordsToUpdate",
              "condition_type": "Expression",
              "expression": {
                "type": "javascript",
                "code": "{{node:code_node_Njvhx8FJ.data.recordsToUpdate}}.size() > 0"
              },
              "filter": {
                "list": [
                  {
                    "id": 1736695973613,
                    "parentId": 1736695973612,
                    "isTop": true,
                    "prop": "",
                    "operator": "",
                    "valueType": "",
                    "value": "",
                    "type": "leaf",
                    "level": 1
                  }
                ]
              }
            },
            "blocks": [
              {
                "id": "if_block_EPpg2mmW",
                "type": "ifBlock",
                "data": { "title": "true" },
                "blocks": [
                  {
                    "id": "update_node_TlZctBXD",
                    "type": "update-node",
                    "data": {
                      "table_id": {
                        "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                        "rules": {
                          "collectionId": "1935880014687440897",
                          "list": [
                            {
                              "id": 1769578248304,
                              "parentId": 1769578248303,
                              "isTop": true,
                              "prop": "id",
                              "operator": "in",
                              "valueType": "field",
                              "value": "{{node:code_node_Njvhx8FJ.data.recordsToUpdate.id}}",
                              "type": "leaf",
                              "level": 1,
                              "propLabel": "ID",
                              "valueLabel": "",
                              "operatorLabel": "In"
                            }
                          ]
                        }
                      },
                      "fields": [],
                      "condition": {},
                      "title": "Update Reserved Table",
                      "isValidator": true,
                      "nodeName": "Update Reserved Table",
                      "name": "Update Reserved Table",
                      "props": {
                        "modelName": "",
                        "list": [
                          {
                            "prop": "id",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordsToUpdate.id}}",
                            "operator": "",
                            "valueLabel": "",
                            "propLabel": "ID"
                          },
                          {
                            "prop": "target_reserved_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordsToUpdate.target_reserved_id}}",
                            "valueLabel": "",
                            "propLabel": "Target Reserved ID"
                          },
                          {
                            "prop": "status",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordsToUpdate.status}}",
                            "valueLabel": "",
                            "propLabel": "Status"
                          },
                          {
                            "prop": "reserved_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordsToUpdate.reserved_qty}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Quantity"
                          },
                          {
                            "prop": "open_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordsToUpdate.open_qty}}",
                            "valueLabel": "",
                            "propLabel": "Open Quantity"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  }
                ]
              },
              {
                "id": "if_block_y0-G5vsi",
                "type": "ifBlock",
                "data": { "title": "false" },
                "blocks": []
              }
            ]
          },
          {
            "id": "if_4PUnrbw2",
            "type": "if",
            "data": {
              "title": "IF recordToCreate ",
              "isValidator": true,
              "nodeName": "IF recordToCreate ",
              "name": "IF recordToCreate ",
              "condition_type": "Expression",
              "expression": {
                "type": "javascript",
                "code": "'{{node:code_node_Njvhx8FJ.data.recordToCreate}}' != 'null'"
              },
              "filter": {
                "list": [
                  {
                    "id": 1736695973613,
                    "parentId": 1736695973612,
                    "isTop": true,
                    "prop": "node.code_node_Njvhx8FJ.data.recordToCreate",
                    "operator": "",
                    "valueType": "value",
                    "value": "",
                    "type": "leaf",
                    "level": 1,
                    "valueLabel": "",
                    "propLabel": "recordsToCreate"
                  }
                ]
              }
            },
            "blocks": [
              {
                "id": "if_block_UkVud6MB",
                "type": "ifBlock",
                "data": { "title": "true" },
                "blocks": [
                  {
                    "id": "add_node_RimiRQTB",
                    "type": "add-node",
                    "data": {
                      "table_id": {
                        "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                        "rules": {
                          "collectionId": "1935880014687440897",
                          "list": [
                            {
                              "id": 1769566749982,
                              "parentId": 1769566749981,
                              "isTop": true,
                              "prop": "",
                              "operator": "",
                              "valueType": "",
                              "value": "",
                              "type": "leaf",
                              "level": 1
                            }
                          ]
                        }
                      },
                      "fields": [],
                      "title": "Add Reserved Table",
                      "isValidator": true,
                      "nodeName": "Add Reserved Table",
                      "name": "Add Reserved Table",
                      "props": {
                        "modelName": "",
                        "list": [
                          {
                            "prop": "doc_type",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.doc_type}}",
                            "operator": "",
                            "valueLabel": "",
                            "propLabel": "Document Type"
                          },
                          {
                            "prop": "status",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.status}}",
                            "valueLabel": "",
                            "propLabel": "Status"
                          },
                          {
                            "prop": "parent_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent ID"
                          },
                          {
                            "prop": "parent_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent Line ID"
                          },
                          {
                            "prop": "parent_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_no}}",
                            "valueLabel": "",
                            "propLabel": "Parent Number"
                          },
                          {
                            "prop": "doc_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_no}}",
                            "valueLabel": "",
                            "propLabel": "Document Number"
                          },
                          {
                            "prop": "doc_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_id}}",
                            "valueLabel": "",
                            "propLabel": "Document ID"
                          },
                          {
                            "prop": "doc_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Document Line ID"
                          },
                          {
                            "prop": "material_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_id}}",
                            "valueLabel": "",
                            "propLabel": "Item ID"
                          },
                          {
                            "prop": "item_code",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_code}}",
                            "valueLabel": "",
                            "propLabel": "Item Code"
                          },
                          {
                            "prop": "item_name",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_name}}",
                            "valueLabel": "",
                            "propLabel": "Item Name"
                          },
                          {
                            "prop": "item_desc",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_desc}}",
                            "valueLabel": "",
                            "propLabel": "Item Description"
                          },
                          {
                            "prop": "batch_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:batch_id}}",
                            "valueLabel": "",
                            "propLabel": "Batch ID"
                          },
                          {
                            "prop": "bin_location",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:location_id}}",
                            "valueLabel": "",
                            "propLabel": "Bin Location"
                          },
                          {
                            "prop": "item_uom",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_uom}}",
                            "valueLabel": "",
                            "propLabel": "UOM"
                          },
                          {
                            "prop": "reserved_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.reserved_qty}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Quantity"
                          },
                          {
                            "prop": "delivered_qty",
                            "operator": "",
                            "valueType": "value",
                            "value": 0,
                            "valueLabel": "",
                            "propLabel": "Delivered Quantity"
                          },
                          {
                            "prop": "open_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.open_qty}}",
                            "valueLabel": "",
                            "propLabel": "Open Quantity"
                          },
                          {
                            "prop": "reserved_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_date}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Date"
                          },
                          {
                            "prop": "line_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:index}}",
                            "valueLabel": "",
                            "propLabel": "Line No"
                          },
                          {
                            "prop": "plant_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:plant_id}}",
                            "valueLabel": "",
                            "propLabel": "Plant ID"
                          },
                          {
                            "prop": "organization_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:organization_id}}",
                            "valueLabel": "",
                            "propLabel": "Organization ID"
                          },
                          {
                            "prop": "remark",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:remark}}",
                            "valueLabel": "",
                            "propLabel": "Remark"
                          },
                          {
                            "prop": "target_reserved_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.target_reserved_id}}",
                            "valueLabel": "",
                            "propLabel": "Target Reserved ID"
                          },
                          {
                            "prop": "source_reserved_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.source_reserved_id}}",
                            "valueLabel": "",
                            "propLabel": "Source Reserved ID"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  },
                  {
                    "id": "if_cSEjTYkj",
                    "type": "if",
                    "data": {
                      "title": "IF Create New Allocation",
                      "isValidator": true,
                      "nodeName": "IF Create New Allocation",
                      "name": "IF Create New Allocation",
                      "condition_type": "Expression",
                      "expression": {
                        "type": "javascript",
                        "code": "'{{node:code_node_Njvhx8FJ.data.recordToCreate.status}}' == 'Allocated'"
                      },
                      "filter": {
                        "list": [
                          {
                            "id": 1736695973613,
                            "parentId": 1736695973612,
                            "isTop": true,
                            "prop": "",
                            "operator": "",
                            "valueType": "",
                            "value": "",
                            "type": "leaf",
                            "level": 1
                          }
                        ]
                      }
                    },
                    "blocks": [
                      {
                        "id": "if_block_xCkE1Ta-",
                        "type": "ifBlock",
                        "data": { "title": "true" },
                        "blocks": [
                          {
                            "id": "workflow_node_L5FWDChd",
                            "type": "workflow-node",
                            "data": {
                              "workflow_id": "",
                              "workflow_name": "",
                              "input_params": {},
                              "title": "Subtract Inventory Workflow",
                              "isValidator": true,
                              "nodeName": "Subtract Inventory Workflow",
                              "name": "Subtract Inventory Workflow",
                              "workflow": {
                                "source": "SUBTRACT_INVENTORY:Workflow:2012096660219564034",
                                "rules": {
                                  "collectionId": "2012096660219564034",
                                  "list": [
                                    {
                                      "id": 1723795236686,
                                      "parentId": 1723795236685,
                                      "isTop": true,
                                      "prop": "",
                                      "operator": "",
                                      "valueType": "",
                                      "value": "",
                                      "type": "leaf",
                                      "level": 1
                                    }
                                  ]
                                }
                              },
                              "remote": true,
                              "remoteType": "innerdatasource",
                              "body_params": {
                                "list": [
                                  {
                                    "prop": "plant_id",
                                    "propLabel": "Plant ID",
                                    "operator": "",
                                    "operatorLabel": "",
                                    "valueType": "field",
                                    "valueTypeLabel": "",
                                    "value": "{{workflowparams:plant_id}}",
                                    "valueLabel": ""
                                  },
                                  {
                                    "prop": "organization_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:organization_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Organization ID"
                                  },
                                  {
                                    "prop": "material_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:material_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Material ID"
                                  },
                                  {
                                    "prop": "quantity",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.reserved_qty}}",
                                    "valueLabel": "",
                                    "propLabel": "Quantity"
                                  },
                                  {
                                    "prop": "material_uom",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:material_uom}}",
                                    "valueLabel": "",
                                    "propLabel": "UOM"
                                  },
                                  {
                                    "prop": "transaction_type",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:transaction_type}}",
                                    "valueLabel": "",
                                    "propLabel": "Transaction Type"
                                  },
                                  {
                                    "prop": "trx_no",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:doc_no}}",
                                    "valueLabel": "",
                                    "propLabel": "Trx No"
                                  },
                                  {
                                    "prop": "inventory_category",
                                    "operator": "",
                                    "valueType": "value",
                                    "value": "Unrestricted",
                                    "valueLabel": "",
                                    "propLabel": "Inventory Category"
                                  },
                                  {
                                    "prop": "location_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:location_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Location ID"
                                  },
                                  {
                                    "prop": "batch_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:batch_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Batch ID"
                                  },
                                  {
                                    "prop": "index",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:index}}",
                                    "valueLabel": "",
                                    "propLabel": "Index"
                                  },
                                  {
                                    "prop": "itemData",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:itemData}}",
                                    "valueLabel": "",
                                    "propLabel": "Item Data"
                                  },
                                  {
                                    "prop": "parent_trx_no",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:parent_no}}",
                                    "valueLabel": "",
                                    "propLabel": "Parent Trx No"
                                  },
                                  {
                                    "prop": "isMovingInv",
                                    "operator": "",
                                    "valueType": "value",
                                    "value": 1,
                                    "valueLabel": "",
                                    "propLabel": "Moving Inventory?"
                                  },
                                  {
                                    "prop": "doc_date",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:doc_date}}",
                                    "valueLabel": "",
                                    "propLabel": "Doc Date"
                                  }
                                ]
                              }
                            },
                            "blocks": []
                          },
                          {
                            "id": "if_JjLgyBBa",
                            "type": "if",
                            "data": {
                              "title": "IF subtractInventory Failed",
                              "isValidator": true,
                              "nodeName": "IF subtractInventory Failed",
                              "name": "IF subtractInventory Failed",
                              "condition_type": "Expression",
                              "filter": {
                                "list": [
                                  {
                                    "id": 1736695973613,
                                    "parentId": 1736695973612,
                                    "isTop": true,
                                    "prop": "",
                                    "operator": "",
                                    "valueType": "",
                                    "value": "",
                                    "type": "leaf",
                                    "level": 1
                                  }
                                ]
                              },
                              "expression": {
                                "type": "javascript",
                                "code": "'{{node:workflow_node_L5FWDChd.data.code}}' == '400'"
                              }
                            },
                            "blocks": [
                              {
                                "id": "ifBlock_xxnLz7T0",
                                "type": "ifBlock",
                                "data": { "title": "true" },
                                "blocks": [
                                  {
                                    "id": "return_node_prPM8t3f",
                                    "type": "return-node",
                                    "data": {
                                      "return_data": {},
                                      "status_code": 200,
                                      "title": "Return Data",
                                      "isValidator": true,
                                      "nodeName": "Return Data",
                                      "name": "Return Data",
                                      "response_value": {
                                        "list": [
                                          {
                                            "prop": "code",
                                            "propLabel": "code",
                                            "operator": "",
                                            "operatorLabel": "",
                                            "valueType": "value",
                                            "valueTypeLabel": "",
                                            "value": "400",
                                            "valueLabel": ""
                                          },
                                          {
                                            "prop": "message",
                                            "operator": "",
                                            "valueType": "field",
                                            "value": "{{node:workflow_node_L5FWDChd.data.errorMessage}}",
                                            "valueLabel": "",
                                            "propLabel": "message"
                                          }
                                        ]
                                      },
                                      "return_raw_data": 0
                                    },
                                    "blocks": []
                                  }
                                ]
                              },
                              {
                                "id": "ifBlock_puk9RWZC",
                                "type": "ifBlock",
                                "data": { "title": "false" },
                                "blocks": []
                              }
                            ]
                          },
                          {
                            "id": "workflow_node_4PM18p0n",
                            "type": "workflow-node",
                            "data": {
                              "workflow_id": "",
                              "workflow_name": "",
                              "input_params": {},
                              "title": "Add Inventory Workflow",
                              "isValidator": true,
                              "nodeName": "Add Inventory Workflow",
                              "name": "Add Inventory Workflow",
                              "workflow": {
                                "source": "ADD_INVENTORY:Workflow:2012005532688723970",
                                "rules": {
                                  "collectionId": "2012005532688723970",
                                  "list": [
                                    {
                                      "id": 1723795236686,
                                      "parentId": 1723795236685,
                                      "isTop": true,
                                      "prop": "",
                                      "operator": "",
                                      "valueType": "",
                                      "value": "",
                                      "type": "leaf",
                                      "level": 1
                                    }
                                  ]
                                }
                              },
                              "remote": true,
                              "remoteType": "innerdatasource",
                              "body_params": {
                                "list": [
                                  {
                                    "prop": "plant_id",
                                    "propLabel": "Plant ID",
                                    "operator": "",
                                    "operatorLabel": "",
                                    "valueType": "field",
                                    "valueTypeLabel": "",
                                    "value": "{{workflowparams:plant_id}}",
                                    "valueLabel": ""
                                  },
                                  {
                                    "prop": "organization_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:organization_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Organization ID"
                                  },
                                  {
                                    "prop": "material_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:material_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Material ID"
                                  },
                                  {
                                    "prop": "quantity",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{node:code_node_Njvhx8FJ.data.recordToCreate.reserved_qty}}",
                                    "valueLabel": "",
                                    "propLabel": "Quantity"
                                  },
                                  {
                                    "prop": "material_uom",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:material_uom}}",
                                    "valueLabel": "",
                                    "propLabel": "UOM"
                                  },
                                  {
                                    "prop": "unit_price",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{node:workflow_node_NF1z0xpf.data.unit_price}}",
                                    "valueLabel": "",
                                    "propLabel": "Unit Price"
                                  },
                                  {
                                    "prop": "transaction_type",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:transaction_type}}",
                                    "valueLabel": "",
                                    "propLabel": "Transaction Type"
                                  },
                                  {
                                    "prop": "trx_no",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:doc_no}}",
                                    "valueLabel": "",
                                    "propLabel": "Trx No"
                                  },
                                  {
                                    "prop": "parent_trx_no",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:parent_no}}",
                                    "valueLabel": "",
                                    "propLabel": "Parent Trx No"
                                  },
                                  {
                                    "prop": "inventory_category",
                                    "operator": "",
                                    "valueType": "value",
                                    "value": "Reserved",
                                    "valueLabel": "",
                                    "propLabel": "Inventory Category"
                                  },
                                  {
                                    "prop": "location_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:location_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Location ID"
                                  },
                                  {
                                    "prop": "batch_id",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:batch_id}}",
                                    "valueLabel": "",
                                    "propLabel": "Batch ID"
                                  },
                                  {
                                    "prop": "index",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:index}}",
                                    "valueLabel": "",
                                    "propLabel": "Index"
                                  },
                                  {
                                    "prop": "itemData",
                                    "operator": "",
                                    "valueType": "field",
                                    "value": "{{workflowparams:itemData}}",
                                    "valueLabel": "",
                                    "propLabel": "Item Data"
                                  },
                                  {
                                    "prop": "isMovingInv",
                                    "operator": "",
                                    "valueType": "value",
                                    "value": 1,
                                    "valueLabel": "",
                                    "propLabel": "Moving Inventory?"
                                  }
                                ]
                              }
                            },
                            "blocks": []
                          },
                          {
                            "id": "if_v73lBMDM",
                            "type": "if",
                            "data": {
                              "title": "IF addInventory Failed",
                              "isValidator": true,
                              "nodeName": "IF addInventory Failed",
                              "name": "IF addInventory Failed",
                              "condition_type": "Expression",
                              "expression": {
                                "type": "javascript",
                                "code": "'{{node:workflow_node_4PM18p0n.data.code}}' == '400'"
                              },
                              "filter": {
                                "list": [
                                  {
                                    "id": 1736695973613,
                                    "parentId": 1736695973612,
                                    "isTop": true,
                                    "prop": "",
                                    "operator": "",
                                    "valueType": "",
                                    "value": "",
                                    "type": "leaf",
                                    "level": 1
                                  }
                                ]
                              }
                            },
                            "blocks": [
                              {
                                "id": "ifBlock_MJxMK0Ga",
                                "type": "ifBlock",
                                "data": { "title": "true" },
                                "blocks": [
                                  {
                                    "id": "return_node_JUmrxJn5",
                                    "type": "return-node",
                                    "data": {
                                      "return_data": {},
                                      "status_code": 200,
                                      "title": "Return Data",
                                      "isValidator": true,
                                      "nodeName": "Return Data",
                                      "name": "Return Data",
                                      "response_value": {
                                        "list": [
                                          {
                                            "prop": "code",
                                            "propLabel": "code",
                                            "operator": "",
                                            "operatorLabel": "",
                                            "valueType": "value",
                                            "valueTypeLabel": "",
                                            "value": "400",
                                            "valueLabel": ""
                                          },
                                          {
                                            "prop": "message",
                                            "operator": "",
                                            "valueType": "field",
                                            "value": "{{node:workflow_node_4PM18p0n.data.errorMessage}}",
                                            "valueLabel": "",
                                            "propLabel": "message"
                                          }
                                        ]
                                      },
                                      "return_raw_data": 0
                                    },
                                    "blocks": []
                                  }
                                ]
                              },
                              {
                                "id": "ifBlock_YuZmH6ny",
                                "type": "ifBlock",
                                "data": { "title": "false" },
                                "blocks": []
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "id": "if_block_4w3wbsgs",
                        "type": "ifBlock",
                        "data": { "title": "false" },
                        "blocks": []
                      }
                    ]
                  }
                ]
              },
              {
                "id": "if_block_qDpLY51j",
                "type": "ifBlock",
                "data": { "title": "false" },
                "blocks": []
              }
            ]
          },
          {
            "id": "return_node_Ob3IcUKs",
            "type": "return-node",
            "data": {
              "return_data": {},
              "status_code": 200,
              "title": "Return Data",
              "isValidator": true,
              "nodeName": "Return Data",
              "name": "Return Data",
              "response_value": {
                "list": [
                  {
                    "prop": "code",
                    "propLabel": "code",
                    "operator": "",
                    "operatorLabel": "",
                    "valueType": "field",
                    "valueTypeLabel": "",
                    "value": "{{node:code_node_Njvhx8FJ.data.code}}",
                    "valueLabel": ""
                  },
                  {
                    "prop": "message",
                    "operator": "",
                    "valueType": "field",
                    "value": "{{node:code_node_Njvhx8FJ.data.message}}",
                    "valueLabel": "",
                    "propLabel": "message"
                  }
                ]
              },
              "return_raw_data": 0
            },
            "blocks": []
          }
        ]
      },
      {
        "id": "condition_or_item_jB3cEN56",
        "type": "condition-or-node-item",
        "data": {
          "title": "Delivered",
          "filter": {
            "list": [
              {
                "id": 1769566528045,
                "parentId": 1769566528044,
                "isTop": true,
                "prop": "",
                "operator": "",
                "valueType": "",
                "value": "",
                "type": "leaf",
                "level": 1
              }
            ]
          },
          "expression": {
            "code": "'{{workflowparams:status}}' == 'Delivered'",
            "type": "javascript"
          },
          "displayContent": "sdk.form.setCondition",
          "__index": 3,
          "isDefault": false,
          "isValidator": true,
          "nodeName": "Delivered",
          "name": "Delivered",
          "condition_type": "Expression"
        },
        "blocks": [
          {
            "id": "search_node_vNmMP0vu",
            "type": "search-node",
            "data": {
              "table_id": {
                "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                "rules": {
                  "collectionId": "1935880014687440897",
                  "list": [
                    {
                      "id": 1769567718496,
                      "parentId": 1769567718497,
                      "isTop": true,
                      "type": "branch",
                      "operator": "all",
                      "prop": "",
                      "valueType": "",
                      "value": "",
                      "level": 1,
                      "children": [
                        {
                          "id": 1769567718489,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "plant_id",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:plant_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Plant ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718498,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "organization_id",
                          "operator": "equal",
                          "valueType": "field",
                          "value": "{{workflowparams:organization_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Organization ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718499,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "material_id",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:material_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Item ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718500,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "bin_location",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:location_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Bin Location",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718501,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "batch_id",
                          "operator": "numberEqual",
                          "valueType": "field",
                          "value": "{{workflowparams:batch_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Batch ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718502,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "status",
                          "operator": "equal",
                          "valueType": "value",
                          "value": "Pending",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Status",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718503,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "parent_id",
                          "operator": "equal",
                          "valueType": "field",
                          "value": "{{workflowparams:parent_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Parent ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        },
                        {
                          "id": 1769567718504,
                          "parentId": 1769567718496,
                          "isTop": false,
                          "prop": "parent_line_id",
                          "operator": "equal",
                          "valueType": "field",
                          "value": "{{workflowparams:parent_line_id}}",
                          "type": "leaf",
                          "level": 2,
                          "propLabel": "Parent Line ID",
                          "valueLabel": "",
                          "operatorLabel": "Equal"
                        }
                      ]
                    }
                  ]
                }
              },
              "condition": {},
              "limit": 100,
              "title": "Get Reserved Table",
              "isValidator": true,
              "nodeName": "Get Reserved Table",
              "name": "Get Reserved Table"
            },
            "blocks": []
          },
          {
            "id": "code_node_xtldYT5d",
            "type": "code-node",
            "data": {
              "language": "javascript",
              "code": "",
              "timeout": 30000,
              "title": "Delivered Record Preparation",
              "isValidator": true,
              "nodeName": "Delivered Record Preparation",
              "name": "Delivered Record Preparation",
              "script": {
                "type": "javascript",
                "code": "// ============================================================================\n// GD DELIVERED STATUS LOGIC (Enhanced for Re-allocation)\n// Handles inventory subtraction and reserved table updates when GD is delivered\n// Supports four scenarios:\n// 1. Normal flow: GD Created  Delivered (allocated qty matches delivery qty)\n//    - Updates Allocated  Delivered, subtracts from Reserved\n// 2. Re-allocation flow: GD Created (edited)  Delivered (qty decreased)\n//    - Releases surplus allocations to Pending\n//    - Updates remaining Allocated  Delivered, subtracts from Reserved\n// 3. Re-allocation flow: GD Created (edited)  Delivered (qty increased)\n//    - Updates all Allocated  Delivered\n//    - Allocates additional from Pending or Unrestricted, marks as Delivered\n// 4. Direct flow: GD straight to Delivered without Allocated records\n//    - Uses Pending  Delivered or Unrestricted directly\n// ============================================================================\n\n// Extract workflow parameters\nconst existingAllocatedData = {{workflowparams:oldAllocatedData}} || [];\nconst existingPendingData = {{node:search_node_vNmMP0vu.data.data}} || [];\nconst quantity = {{workflowparams:quantity}};\nconst parentId = {{workflowparams:parent_id}};\nconst parentLineId = {{workflowparams:parent_line_id}};\nconst parentNo = {{workflowparams:parent_no}};\nconst docId = {{workflowparams:doc_id}};\nconst docLineId = {{workflowparams:doc_line_id}};\nconst docNo = {{workflowparams:doc_no}};\nconst materialId = {{workflowparams:material_id}};\nconst itemData = {{workflowparams:itemData}};\nconst batchId = {{workflowparams:batch_id}};\nconst locationId = {{workflowparams:location_id}};\nconst materialUom = {{workflowparams:material_uom}};\nconst docDate = {{workflowparams:doc_date}};\nconst index = {{workflowparams:index}};\nconst plantId = {{workflowparams:plant_id}};\nconst organizationId = {{workflowparams:organization_id}};\nconst remark = {{workflowparams:remark}};\n\n// ============================================================================\n// STEP 1: Find Matching Allocated Records\n// ============================================================================\n\nconst matchedAllocatedRecords = existingAllocatedData.filter(\n  (record) =>\n    record.doc_line_id === docLineId &&\n    record.material_id === materialId &&\n    record.batch_id === batchId &&\n    record.bin_location === locationId &&\n    record.status === \"Allocated\" &&\n    record.target_reserved_id === docId,\n);\n\n// ============================================================================\n// SCENARIO 1, 2, 3: HAS ALLOCATED RECORDS (GD Created  Delivered)\n// ============================================================================\n\nif (matchedAllocatedRecords.length > 0) {\n  // Calculate total allocated quantity\n  const totalAllocatedQty = matchedAllocatedRecords.reduce(\n    (sum, r) => sum + (r.open_qty || 0),\n    0,\n  );\n\n  const recordsToUpdate = [];\n  let recordToCreate = null;\n  let reservedQtyToSubtract = 0;\n  let unrestrictedQtyToSubtract = 0;\n\n  // -------------------------------------------------------------------------\n  // CASE A: Delivery qty <= Allocated qty (Normal or Decreased)\n  // -------------------------------------------------------------------------\n  if (quantity <= totalAllocatedQty) {\n    let remainingQtyToDeliver = quantity;\n    let remainingQtyToRelease = totalAllocatedQty - quantity;\n\n    // Process allocated records in order (FIFO)\n    for (const allocatedRecord of matchedAllocatedRecords) {\n      if (remainingQtyToDeliver <= 0 && remainingQtyToRelease <= 0) break;\n\n      const recordQty = allocatedRecord.open_qty || 0;\n\n      if (remainingQtyToDeliver > 0) {\n        // Deliver from this record\n        const deliverFromThisRecord = Math.min(recordQty, remainingQtyToDeliver);\n\n        if (deliverFromThisRecord === recordQty) {\n          // Fully deliver this record\n          recordsToUpdate.push({\n            ...allocatedRecord,\n            status: \"Delivered\",\n            delivered_qty: (allocatedRecord.delivered_qty || 0) + deliverFromThisRecord,\n            open_qty: 0,\n          });\n        } else {\n          // Partial deliver - need to split\n          // Update original to Delivered with delivered portion\n          recordsToUpdate.push({\n            ...allocatedRecord,\n            reserved_qty: deliverFromThisRecord,\n            open_qty: 0,\n            delivered_qty: deliverFromThisRecord,\n            status: \"Delivered\",\n          });\n\n          // Create Pending record for remaining portion (to be released)\n          const { _id, id, ...recordWithoutId } = allocatedRecord;\n          recordToCreate = {\n            ...recordWithoutId,\n            reserved_qty: recordQty - deliverFromThisRecord,\n            open_qty: recordQty - deliverFromThisRecord,\n            delivered_qty: 0,\n            status: \"Pending\",\n            target_reserved_id: null,\n          };\n        }\n\n        remainingQtyToDeliver -= deliverFromThisRecord;\n        reservedQtyToSubtract += deliverFromThisRecord;\n      } else if (remainingQtyToRelease > 0) {\n        // Release this record back to Pending (user decreased qty)\n        const releaseFromThisRecord = Math.min(recordQty, remainingQtyToRelease);\n\n        if (releaseFromThisRecord === recordQty) {\n          // Fully release to Pending\n          recordsToUpdate.push({\n            ...allocatedRecord,\n            status: \"Pending\",\n            target_reserved_id: null,\n          });\n        } else {\n          // Partial release - keep allocated portion, release remainder\n          recordsToUpdate.push({\n            ...allocatedRecord,\n            reserved_qty: recordQty - releaseFromThisRecord,\n            open_qty: recordQty - releaseFromThisRecord,\n            status: \"Allocated\",\n          });\n\n          const { _id, id, ...recordWithoutId } = allocatedRecord;\n          recordToCreate = {\n            ...recordWithoutId,\n            reserved_qty: releaseFromThisRecord,\n            open_qty: releaseFromThisRecord,\n            delivered_qty: 0,\n            status: \"Pending\",\n            target_reserved_id: null,\n          };\n        }\n\n        remainingQtyToRelease -= releaseFromThisRecord;\n        // No inventory movement for released qty - stays in Reserved category\n      }\n    }\n\n    return {\n      code: \"200\",\n      recordsToUpdate,\n      recordToCreate,\n      inventoryMovements: [\n        {\n          source: \"Reserved\",\n          quantity: reservedQtyToSubtract,\n          operation: \"subtract\",\n        },\n      ],\n      message:\n        quantity < totalAllocatedQty\n          ? \"Delivery processed with re-allocation (decreased qty)\"\n          : \"Delivery processed from allocated inventory (Reserved)\",\n    };\n  }\n\n  // -------------------------------------------------------------------------\n  // CASE B: Delivery qty > Allocated qty (Increased - need more allocation)\n  // -------------------------------------------------------------------------\n  if (quantity > totalAllocatedQty) {\n    // First, deliver all allocated records\n    for (const allocatedRecord of matchedAllocatedRecords) {\n      recordsToUpdate.push({\n        ...allocatedRecord,\n        status: \"Delivered\",\n        delivered_qty: (allocatedRecord.delivered_qty || 0) + allocatedRecord.open_qty,\n        open_qty: 0,\n      });\n    }\n    reservedQtyToSubtract = totalAllocatedQty;\n\n    // Now allocate+deliver additional quantity from Pending or Unrestricted\n    let additionalQtyNeeded = quantity - totalAllocatedQty;\n\n    // Filter pending records matching this temp_data item\n    const matchedPendingRecords = existingPendingData.filter(\n      (record) =>\n        record.material_id === materialId &&\n        record.batch_id === batchId &&\n        record.bin_location === locationId &&\n        record.status === \"Pending\",\n    );\n\n    // Separate by source type for priority handling\n    const pendingProdReceiptData = matchedPendingRecords.filter(\n      (item) => item.doc_type === \"Production Receipt\",\n    );\n    const pendingSOData = matchedPendingRecords.filter(\n      (item) => item.doc_type === \"Sales Order\",\n    );\n\n    // Validate: Only one pending record per source type allowed\n    if (pendingSOData.length > 1) {\n      return {\n        code: \"400\",\n        message: \"Multiple pending sales orders found\",\n      };\n    }\n    if (pendingProdReceiptData.length > 1) {\n      return {\n        code: \"400\",\n        message: \"Multiple pending production receipts found\",\n      };\n    }\n\n    // PRIORITY 1: Deliver from Production Receipt Pending\n    if (pendingProdReceiptData.length > 0 && additionalQtyNeeded > 0) {\n      const prodReceiptQty = pendingProdReceiptData[0].open_qty || 0;\n      const deliverQty = Math.min(prodReceiptQty, additionalQtyNeeded);\n\n      if (deliverQty === prodReceiptQty) {\n        // Fully consume and deliver\n        recordsToUpdate.push({\n          ...pendingProdReceiptData[0],\n          status: \"Delivered\",\n          delivered_qty: deliverQty,\n          open_qty: 0,\n          target_reserved_id: docId,\n        });\n      } else {\n        // Partial - deliver portion, keep remainder as Pending\n        recordsToUpdate.push({\n          ...pendingProdReceiptData[0],\n          reserved_qty: deliverQty,\n          open_qty: 0,\n          delivered_qty: deliverQty,\n          status: \"Delivered\",\n          target_reserved_id: docId,\n        });\n\n        const { _id, id, ...prodReceiptWithoutId } = pendingProdReceiptData[0];\n        recordToCreate = {\n          ...prodReceiptWithoutId,\n          reserved_qty: prodReceiptQty - deliverQty,\n          open_qty: prodReceiptQty - deliverQty,\n          delivered_qty: 0,\n          status: \"Pending\",\n          target_reserved_id: null,\n        };\n      }\n\n      reservedQtyToSubtract += deliverQty;\n      additionalQtyNeeded -= deliverQty;\n    }\n\n    // PRIORITY 2: Deliver from Sales Order Pending\n    if (pendingSOData.length > 0 && additionalQtyNeeded > 0) {\n      const soQty = pendingSOData[0].open_qty || 0;\n      const deliverQty = Math.min(soQty, additionalQtyNeeded);\n\n      if (deliverQty === soQty) {\n        // Fully consume and deliver\n        recordsToUpdate.push({\n          ...pendingSOData[0],\n          status: \"Delivered\",\n          delivered_qty: deliverQty,\n          open_qty: 0,\n          target_reserved_id: docId,\n        });\n      } else {\n        // Partial - deliver portion, keep remainder as Pending\n        recordsToUpdate.push({\n          ...pendingSOData[0],\n          reserved_qty: deliverQty,\n          open_qty: 0,\n          delivered_qty: deliverQty,\n          status: \"Delivered\",\n          target_reserved_id: docId,\n        });\n\n        const { _id, id, ...soWithoutId } = pendingSOData[0];\n        recordToCreate = {\n          ...soWithoutId,\n          reserved_qty: soQty - deliverQty,\n          open_qty: soQty - deliverQty,\n          delivered_qty: 0,\n          status: \"Pending\",\n          target_reserved_id: null,\n        };\n      }\n\n      reservedQtyToSubtract += deliverQty;\n      additionalQtyNeeded -= deliverQty;\n    }\n\n    // FALLBACK: Deliver from Unrestricted (no reserved_table record created)\n    if (additionalQtyNeeded > 0) {\n      unrestrictedQtyToSubtract = additionalQtyNeeded;\n      additionalQtyNeeded = 0;\n    }\n\n    return {\n      code: \"200\",\n      recordsToUpdate,\n      recordToCreate,\n      inventoryMovements: [\n        ...(reservedQtyToSubtract > 0\n          ? [\n              {\n                source: \"Reserved\",\n                quantity: reservedQtyToSubtract,\n                operation: \"subtract\",\n              },\n            ]\n          : []),\n        ...(unrestrictedQtyToSubtract > 0\n          ? [\n              {\n                source: \"Unrestricted\",\n                quantity: unrestrictedQtyToSubtract,\n                operation: \"subtract\",\n              },\n            ]\n          : []),\n      ],\n      message: \"Delivery processed with re-allocation (increased qty)\",\n    };\n  }\n}\n\n// ============================================================================\n// SCENARIO 4: NO ALLOCATED RECORDS (Direct to Delivered)\n// Check if Pending records are available\n// ============================================================================\n\n// Filter pending records matching this temp_data item\nconst matchedPendingRecords = existingPendingData.filter(\n  (record) =>\n    record.material_id === materialId &&\n    record.batch_id === batchId &&\n    record.bin_location === locationId &&\n    record.status === \"Pending\",\n);\n\n// Separate by source type for priority handling\nconst pendingSOData = matchedPendingRecords.filter(\n  (item) => item.doc_type === \"Sales Order\",\n);\n\nconst pendingProdReceiptData = matchedPendingRecords.filter(\n  (item) => item.doc_type === \"Production Receipt\",\n);\n\n// Validate: Only one pending record per source type allowed\nif (pendingSOData.length > 1) {\n  return {\n    code: \"400\",\n    message: \"Multiple pending sales orders found\",\n  };\n}\n\nif (pendingProdReceiptData.length > 1) {\n  return {\n    code: \"400\",\n    message: \"Multiple pending production receipts found\",\n  };\n}\n\nconst salesOrderOpenQty =\n  pendingSOData.length > 0 ? pendingSOData[0].open_qty : 0;\nconst productionReceiptOpenQty =\n  pendingProdReceiptData.length > 0 ? pendingProdReceiptData[0].open_qty : 0;\n\nlet remainingQtyToDeliver = quantity;\nconst recordsToUpdate = [];\nlet recordToCreate = null;\nlet reservedQty = 0; // Track how much comes from Reserved (Pending)\nlet unrestrictedQty = 0; // Track how much comes from Unrestricted\n\n// -------------------------------------------------------------------------\n// PRIORITY 1: Deliver from Production Receipt Pending\n// -------------------------------------------------------------------------\nif (pendingProdReceiptData.length > 0 && remainingQtyToDeliver > 0) {\n  const deliverQty = Math.min(productionReceiptOpenQty, remainingQtyToDeliver);\n\n  if (deliverQty === productionReceiptOpenQty) {\n    // Fully consume pending - mark as Delivered\n    recordsToUpdate.push({\n      ...pendingProdReceiptData[0],\n      status: \"Delivered\",\n      delivered_qty: deliverQty,\n      open_qty: 0,\n      target_reserved_id: docId,\n    });\n  } else {\n    // Partial delivery - split the record\n    // Update original to Delivered with delivered quantity\n    recordsToUpdate.push({\n      ...pendingProdReceiptData[0],\n      reserved_qty: deliverQty,\n      open_qty: 0,\n      delivered_qty: deliverQty,\n      status: \"Delivered\",\n      target_reserved_id: docId,\n    });\n\n    // Create new Pending record for remaining quantity\n    const { _id, id, ...prodReceiptWithoutId } = pendingProdReceiptData[0];\n    recordToCreate = {\n      ...prodReceiptWithoutId,\n      reserved_qty: productionReceiptOpenQty - deliverQty,\n      open_qty: productionReceiptOpenQty - deliverQty,\n      delivered_qty: 0,\n      status: \"Pending\",\n      target_reserved_id: null,\n    };\n  }\n\n  reservedQty += deliverQty;\n  remainingQtyToDeliver -= deliverQty;\n}\n\n// -------------------------------------------------------------------------\n// PRIORITY 2: Deliver from Sales Order Pending\n// -------------------------------------------------------------------------\nif (pendingSOData.length > 0 && remainingQtyToDeliver > 0) {\n  const deliverQty = Math.min(salesOrderOpenQty, remainingQtyToDeliver);\n\n  if (deliverQty === salesOrderOpenQty) {\n    // Fully consume pending - mark as Delivered\n    recordsToUpdate.push({\n      ...pendingSOData[0],\n      status: \"Delivered\",\n      delivered_qty: deliverQty,\n      open_qty: 0,\n      target_reserved_id: docId,\n    });\n  } else {\n    // Partial delivery - split the record\n    // Update original to Delivered with delivered quantity\n    recordsToUpdate.push({\n      ...pendingSOData[0],\n      reserved_qty: deliverQty,\n      open_qty: 0,\n      delivered_qty: deliverQty,\n      status: \"Delivered\",\n      target_reserved_id: docId,\n    });\n\n    // Create new Pending record for remaining quantity\n    const { _id, id, ...soWithoutId } = pendingSOData[0];\n    recordToCreate = {\n      ...soWithoutId,\n      reserved_qty: salesOrderOpenQty - deliverQty,\n      open_qty: salesOrderOpenQty - deliverQty,\n      delivered_qty: 0,\n      status: \"Pending\",\n      target_reserved_id: null,\n    };\n  }\n\n  reservedQty += deliverQty;\n  remainingQtyToDeliver -= deliverQty;\n}\n\n// -------------------------------------------------------------------------\n// FALLBACK: Deliver from Unrestricted Inventory (No Pending Available)\n// -------------------------------------------------------------------------\nif (remainingQtyToDeliver > 0) {\n  // NO reserved_table record created - inventory was never reserved\n  // Just track the quantity for inventory movement (Unrestricted  Out)\n  // Traceability is maintained through:\n  // - The GD document itself (has all line/temp_data details)\n  // - Inventory transaction history (plant_stock_balance movements)\n  const deliverQty = remainingQtyToDeliver;\n\n  unrestrictedQty += deliverQty;\n  remainingQtyToDeliver -= deliverQty;\n\n  // recordToCreate stays as-is (null or previous Pending split record)\n}\n\n// ============================================================================\n// RETURN RESULTS\n// ============================================================================\n\nreturn {\n  code: \"200\",\n  recordsToUpdate,\n  recordToCreate,\n  inventoryMovements: [\n    ...(reservedQty > 0\n      ? [\n          {\n            source: \"Reserved\",\n            quantity: reservedQty,\n            operation: \"subtract\",\n          },\n        ]\n      : []),\n    ...(unrestrictedQty > 0\n      ? [\n          {\n            source: \"Unrestricted\",\n            quantity: unrestrictedQty,\n            operation: \"subtract\",\n          },\n        ]\n      : []),\n  ],\n  message: \"Delivery processed successfully\",\n};\n"
              },
              "response_json": [
                {
                  "key": "okro9jfm",
                  "name": "code",
                  "title": "code",
                  "description": "",
                  "bsonType": "string",
                  "isExpand": false
                },
                {
                  "key": "1ecx9wxp",
                  "name": "recordsToUpdate",
                  "title": "recordsToUpdate",
                  "description": "",
                  "bsonType": "array",
                  "isExpand": true,
                  "children": [
                    {
                      "key": "po5binpe",
                      "name": "items",
                      "title": "",
                      "description": "",
                      "bsonType": "any",
                      "isExpand": false,
                      "isArrayItem": true,
                      "children": []
                    }
                  ]
                },
                {
                  "key": "xjbtep69",
                  "name": "recordToCreate",
                  "title": "recordsToCreate",
                  "description": "",
                  "bsonType": "any",
                  "isExpand": false,
                  "children": []
                },
                {
                  "key": "ii7sab6f",
                  "name": "message",
                  "title": "message",
                  "description": "",
                  "bsonType": "string",
                  "isExpand": false
                },
                {
                  "key": "2umot2w7",
                  "name": "inventoryMovements",
                  "title": "inventoryMovements",
                  "description": "",
                  "bsonType": "array",
                  "isExpand": true,
                  "children": [
                    {
                      "key": "7wixajfo",
                      "name": "items",
                      "title": "",
                      "description": "",
                      "bsonType": "any",
                      "isExpand": false,
                      "isArrayItem": true,
                      "children": []
                    }
                  ]
                }
              ]
            },
            "blocks": []
          },
          {
            "id": "if_2d7xxegB",
            "type": "if",
            "data": {
              "title": "Error Handling",
              "isValidator": true,
              "nodeName": "Error Handling",
              "name": "Error Handling",
              "condition_type": "ConditionRule",
              "expression": { "type": "javascript", "code": "" },
              "filter": {
                "list": [
                  {
                    "id": 1736695973613,
                    "parentId": 1736695973612,
                    "isTop": true,
                    "prop": "node.code_node_xtldYT5d.data.code",
                    "operator": "equal",
                    "valueType": "value",
                    "value": "400",
                    "type": "leaf",
                    "level": 1,
                    "propLabel": "code",
                    "valueLabel": "",
                    "operatorLabel": "Equal"
                  }
                ]
              }
            },
            "blocks": [
              {
                "id": "ifBlock_6uyEMZ8J",
                "type": "ifBlock",
                "data": { "title": "true" },
                "blocks": [
                  {
                    "id": "return_node_KPUCYhqA",
                    "type": "return-node",
                    "data": {
                      "return_data": {},
                      "status_code": 200,
                      "title": "Return Data",
                      "isValidator": true,
                      "nodeName": "Return Data",
                      "name": "Return Data",
                      "response_value": {
                        "list": [
                          {
                            "prop": "code",
                            "propLabel": "code",
                            "operator": "",
                            "operatorLabel": "",
                            "valueType": "field",
                            "valueTypeLabel": "",
                            "value": "{{node:code_node_xtldYT5d.data.code}}",
                            "valueLabel": ""
                          },
                          {
                            "prop": "message",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.message}}",
                            "valueLabel": "",
                            "propLabel": "message"
                          }
                        ]
                      },
                      "return_raw_data": 0
                    },
                    "blocks": []
                  }
                ]
              },
              {
                "id": "ifBlock_EOanrY9F",
                "type": "ifBlock",
                "data": { "title": "false" },
                "blocks": []
              }
            ]
          },
          {
            "id": "if_ijEgIKlc",
            "type": "if",
            "data": {
              "title": "IF recordsToUpdate",
              "isValidator": true,
              "nodeName": "IF recordsToUpdate",
              "name": "IF recordsToUpdate",
              "condition_type": "Expression",
              "expression": {
                "type": "javascript",
                "code": "{{node:code_node_xtldYT5d.data.recordsToUpdate}}.size() > 0"
              },
              "filter": {
                "list": [
                  {
                    "id": 1736695973613,
                    "parentId": 1736695973612,
                    "isTop": true,
                    "prop": "",
                    "operator": "",
                    "valueType": "",
                    "value": "",
                    "type": "leaf",
                    "level": 1
                  }
                ]
              }
            },
            "blocks": [
              {
                "id": "ifBlock_wHWpy2iv",
                "type": "ifBlock",
                "data": { "title": "true" },
                "blocks": [
                  {
                    "id": "update_node_KRU7doPX",
                    "type": "update-node",
                    "data": {
                      "table_id": {
                        "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                        "rules": {
                          "collectionId": "1935880014687440897",
                          "list": [
                            {
                              "id": 1769578248304,
                              "parentId": 1769578248303,
                              "isTop": true,
                              "prop": "id",
                              "operator": "in",
                              "valueType": "field",
                              "value": "{{node:code_node_xtldYT5d.data.recordsToUpdate.id}}",
                              "type": "leaf",
                              "level": 1,
                              "propLabel": "ID",
                              "valueLabel": "",
                              "operatorLabel": "In"
                            }
                          ]
                        }
                      },
                      "fields": [],
                      "condition": {},
                      "title": "Update Reserved Table",
                      "isValidator": true,
                      "nodeName": "Update Reserved Table",
                      "name": "Update Reserved Table",
                      "props": {
                        "modelName": "",
                        "list": [
                          {
                            "prop": "id",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordsToUpdate.id}}",
                            "operator": "",
                            "valueLabel": "",
                            "propLabel": "ID"
                          },
                          {
                            "prop": "target_reserved_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordsToUpdate.target_reserved_id}}",
                            "valueLabel": "",
                            "propLabel": "Target Reserved ID"
                          },
                          {
                            "prop": "status",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordsToUpdate.status}}",
                            "valueLabel": "",
                            "propLabel": "Status"
                          },
                          {
                            "prop": "reserved_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordsToUpdate.reserved_qty}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Quantity"
                          },
                          {
                            "prop": "open_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordsToUpdate.open_qty}}",
                            "valueLabel": "",
                            "propLabel": "Open Quantity"
                          },
                          {
                            "prop": "delivered_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordsToUpdate.delivered_qty}}",
                            "valueLabel": "",
                            "propLabel": "Delivered Quantity"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  }
                ]
              },
              {
                "id": "ifBlock_URrjfh93",
                "type": "ifBlock",
                "data": { "title": "false" },
                "blocks": []
              }
            ]
          },
          {
            "id": "if_QqZfTtCo",
            "type": "if",
            "data": {
              "title": "IF recordToCreate ",
              "isValidator": true,
              "nodeName": "IF recordToCreate ",
              "name": "IF recordToCreate ",
              "condition_type": "Expression",
              "expression": {
                "type": "javascript",
                "code": "'{{node:code_node_xtldYT5d.data.recordToCreate}}' != 'null'"
              },
              "filter": {
                "list": [
                  {
                    "id": 1736695973613,
                    "parentId": 1736695973612,
                    "isTop": true,
                    "prop": "node.code_node_Njvhx8FJ.data.recordToCreate",
                    "operator": "",
                    "valueType": "value",
                    "value": "",
                    "type": "leaf",
                    "level": 1,
                    "valueLabel": "",
                    "propLabel": "recordsToCreate"
                  }
                ]
              }
            },
            "blocks": [
              {
                "id": "ifBlock_BP1xoobM",
                "type": "ifBlock",
                "data": { "title": "true" },
                "blocks": [
                  {
                    "id": "add_node_178Q7f9M",
                    "type": "add-node",
                    "data": {
                      "table_id": {
                        "source": "On Reserved Goods Delivery:Table:1935880014687440897",
                        "rules": {
                          "collectionId": "1935880014687440897",
                          "list": [
                            {
                              "id": 1769566749982,
                              "parentId": 1769566749981,
                              "isTop": true,
                              "prop": "",
                              "operator": "",
                              "valueType": "",
                              "value": "",
                              "type": "leaf",
                              "level": 1
                            }
                          ]
                        }
                      },
                      "fields": [],
                      "title": "Add Reserved Table",
                      "isValidator": true,
                      "nodeName": "Add Reserved Table",
                      "name": "Add Reserved Table",
                      "props": {
                        "modelName": "",
                        "list": [
                          {
                            "prop": "doc_type",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordToCreate.doc_type}}",
                            "operator": "",
                            "valueLabel": "",
                            "propLabel": "Document Type"
                          },
                          {
                            "prop": "status",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordToCreate.status}}",
                            "valueLabel": "",
                            "propLabel": "Status"
                          },
                          {
                            "prop": "parent_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent ID"
                          },
                          {
                            "prop": "parent_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Parent Line ID"
                          },
                          {
                            "prop": "parent_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:parent_no}}",
                            "valueLabel": "",
                            "propLabel": "Parent Number"
                          },
                          {
                            "prop": "doc_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_no}}",
                            "valueLabel": "",
                            "propLabel": "Document Number"
                          },
                          {
                            "prop": "doc_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_id}}",
                            "valueLabel": "",
                            "propLabel": "Document ID"
                          },
                          {
                            "prop": "doc_line_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_line_id}}",
                            "valueLabel": "",
                            "propLabel": "Document Line ID"
                          },
                          {
                            "prop": "material_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_id}}",
                            "valueLabel": "",
                            "propLabel": "Item ID"
                          },
                          {
                            "prop": "item_code",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_code}}",
                            "valueLabel": "",
                            "propLabel": "Item Code"
                          },
                          {
                            "prop": "item_name",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_name}}",
                            "valueLabel": "",
                            "propLabel": "Item Name"
                          },
                          {
                            "prop": "item_desc",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:itemData.material_desc}}",
                            "valueLabel": "",
                            "propLabel": "Item Description"
                          },
                          {
                            "prop": "batch_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:batch_id}}",
                            "valueLabel": "",
                            "propLabel": "Batch ID"
                          },
                          {
                            "prop": "bin_location",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:location_id}}",
                            "valueLabel": "",
                            "propLabel": "Bin Location"
                          },
                          {
                            "prop": "item_uom",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:material_uom}}",
                            "valueLabel": "",
                            "propLabel": "UOM"
                          },
                          {
                            "prop": "reserved_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordToCreate.reserved_qty}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Quantity"
                          },
                          {
                            "prop": "delivered_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordToCreate.delivered_qty}}",
                            "valueLabel": "",
                            "propLabel": "Delivered Quantity"
                          },
                          {
                            "prop": "open_qty",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordToCreate.open_qty}}",
                            "valueLabel": "",
                            "propLabel": "Open Quantity"
                          },
                          {
                            "prop": "reserved_date",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:doc_date}}",
                            "valueLabel": "",
                            "propLabel": "Reserved Date"
                          },
                          {
                            "prop": "line_no",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:index}}",
                            "valueLabel": "",
                            "propLabel": "Line No"
                          },
                          {
                            "prop": "plant_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:plant_id}}",
                            "valueLabel": "",
                            "propLabel": "Plant ID"
                          },
                          {
                            "prop": "organization_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:organization_id}}",
                            "valueLabel": "",
                            "propLabel": "Organization ID"
                          },
                          {
                            "prop": "remark",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{workflowparams:remark}}",
                            "valueLabel": "",
                            "propLabel": "Remark"
                          },
                          {
                            "prop": "target_reserved_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordToCreate.target_reserved_id}}",
                            "valueLabel": "",
                            "propLabel": "Target Reserved ID"
                          },
                          {
                            "prop": "source_reserved_id",
                            "operator": "",
                            "valueType": "field",
                            "value": "{{node:code_node_xtldYT5d.data.recordToCreate.source_reserved_id}}",
                            "valueLabel": "",
                            "propLabel": "Source Reserved ID"
                          }
                        ]
                      }
                    },
                    "blocks": []
                  }
                ]
              },
              {
                "id": "ifBlock_j8HDfaPO",
                "type": "ifBlock",
                "data": { "title": "false" },
                "blocks": []
              }
            ]
          },
          {
            "id": "if_LeDxvSX2",
            "type": "if",
            "data": {
              "title": "IF inventoryMovements size",
              "isValidator": true,
              "nodeName": "IF inventoryMovements size",
              "name": "IF inventoryMovements size",
              "condition_type": "Expression",
              "expression": {
                "type": "javascript",
                "code": "{{node:code_node_xtldYT5d.data.inventoryMovements}}.size() > 0"
              },
              "filter": {
                "list": [
                  {
                    "id": 1736695973613,
                    "parentId": 1736695973612,
                    "isTop": true,
                    "prop": "",
                    "operator": "",
                    "valueType": "",
                    "value": "",
                    "type": "leaf",
                    "level": 1
                  }
                ]
              }
            },
            "blocks": [
              {
                "id": "ifBlock_33fE12I2",
                "type": "ifBlock",
                "data": { "title": "true" },
                "blocks": [
                  {
                    "id": "set_cache_node_KgXP1By2",
                    "type": "set-cache-node",
                    "data": {
                      "cache_key": "",
                      "cache_value": "",
                      "expire_time": 3600,
                      "title": "Set inventoryMovements Index",
                      "isValidator": true,
                      "nodeName": "Set inventoryMovements Index",
                      "name": "Set inventoryMovements Index",
                      "custom_wkbocgni": { "type": "javascript", "code": "0" },
                      "redis_key": "inventoryMovementsIndex"
                    },
                    "blocks": []
                  },
                  {
                    "id": "loop_N0VVV0LH",
                    "type": "loop",
                    "data": {
                      "title": "Loop inventoryMovements",
                      "isValidator": true,
                      "nodeName": "Loop inventoryMovements",
                      "name": "Loop inventoryMovements",
                      "loopType": "Var",
                      "loopSeletVar": {
                        "type": "markdown",
                        "code": "{{node:code_node_xtldYT5d.data.inventoryMovements}}"
                      }
                    },
                    "blocks": [
                      {
                        "id": "get_cache_node_hYH0rv6u",
                        "type": "get-cache-node",
                        "data": {
                          "cache_key": "",
                          "default_value": null,
                          "title": "Get inventoryMovements Index",
                          "isValidator": true,
                          "nodeName": "Get inventoryMovements Index",
                          "name": "Get inventoryMovements Index",
                          "redis_key": "inventoryMovementsIndex"
                        },
                        "blocks": []
                      },
                      {
                        "id": "code_node_2uHAOiqe",
                        "type": "code-node",
                        "data": {
                          "language": "javascript",
                          "code": "",
                          "timeout": 30000,
                          "title": "inventoryMovements Preparation",
                          "isValidator": true,
                          "nodeName": "inventoryMovements Preparation",
                          "name": "inventoryMovements Preparation",
                          "script": {
                            "type": "javascript",
                            "code": "const inventoryMovements = {{node:code_node_xtldYT5d.data.inventoryMovements}};\nconst currentIndexRaw = {{node:get_cache_node_hYH0rv6u.data}};\nconst index = currentIndexRaw ? parseInt(currentIndexRaw, 10) : 0;\n\nconst inventory = inventoryMovements[index];\nconst inventoryCategory = inventory.source;\nconst quantity = inventory.quantity;\n\nreturn {\n  inventoryCategory: inventoryCategory,\n  quantity: quantity,\n  index: index,\n  nextIndex: index + 1\n}"
                          },
                          "response_json": [
                            {
                              "key": "4ogr6so9",
                              "name": "inventoryCategory",
                              "title": "inventoryCategory",
                              "description": "",
                              "bsonType": "string",
                              "isExpand": false
                            },
                            {
                              "key": "td3essy7",
                              "name": "quantity",
                              "title": "quantity",
                              "description": "",
                              "bsonType": "decimal",
                              "isExpand": false,
                              "children": []
                            },
                            {
                              "key": "ccurdd1g",
                              "name": "index",
                              "title": "index",
                              "description": "",
                              "bsonType": "int",
                              "isExpand": false,
                              "children": []
                            },
                            {
                              "key": "105u5ewr",
                              "name": "nextIndex",
                              "title": "nextIndex",
                              "description": "",
                              "bsonType": "int",
                              "isExpand": false,
                              "children": []
                            }
                          ]
                        },
                        "blocks": []
                      },
                      {
                        "id": "workflow_node_QTdqcGY1",
                        "type": "workflow-node",
                        "data": {
                          "workflow_id": "",
                          "workflow_name": "",
                          "input_params": {},
                          "title": "Subtract Inventory Workflow",
                          "isValidator": true,
                          "nodeName": "Subtract Inventory Workflow",
                          "name": "Subtract Inventory Workflow",
                          "workflow": {
                            "source": "SUBTRACT_INVENTORY:Workflow:2012096660219564034",
                            "rules": {
                              "collectionId": "2012096660219564034",
                              "list": [
                                {
                                  "id": 1723795236686,
                                  "parentId": 1723795236685,
                                  "isTop": true,
                                  "prop": "",
                                  "operator": "",
                                  "valueType": "",
                                  "value": "",
                                  "type": "leaf",
                                  "level": 1
                                }
                              ]
                            }
                          },
                          "remote": true,
                          "remoteType": "innerdatasource",
                          "body_params": {
                            "list": [
                              {
                                "prop": "plant_id",
                                "propLabel": "Plant ID",
                                "operator": "",
                                "operatorLabel": "",
                                "valueType": "field",
                                "valueTypeLabel": "",
                                "value": "{{workflowparams:plant_id}}",
                                "valueLabel": ""
                              },
                              {
                                "prop": "organization_id",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:organization_id}}",
                                "valueLabel": "",
                                "propLabel": "Organization ID"
                              },
                              {
                                "prop": "material_id",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:material_id}}",
                                "valueLabel": "",
                                "propLabel": "Material ID"
                              },
                              {
                                "prop": "quantity",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{node:code_node_2uHAOiqe.data.quantity}}",
                                "valueLabel": "",
                                "propLabel": "Quantity"
                              },
                              {
                                "prop": "material_uom",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:material_uom}}",
                                "valueLabel": "",
                                "propLabel": "UOM"
                              },
                              {
                                "prop": "transaction_type",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:transaction_type}}",
                                "valueLabel": "",
                                "propLabel": "Transaction Type"
                              },
                              {
                                "prop": "trx_no",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:doc_no}}",
                                "valueLabel": "",
                                "propLabel": "Trx No"
                              },
                              {
                                "prop": "inventory_category",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{node:code_node_2uHAOiqe.data.inventoryCategory}}",
                                "valueLabel": "",
                                "propLabel": "Inventory Category"
                              },
                              {
                                "prop": "location_id",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:location_id}}",
                                "valueLabel": "",
                                "propLabel": "Location ID"
                              },
                              {
                                "prop": "batch_id",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:batch_id}}",
                                "valueLabel": "",
                                "propLabel": "Batch ID"
                              },
                              {
                                "prop": "index",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:index}}",
                                "valueLabel": "",
                                "propLabel": "Index"
                              },
                              {
                                "prop": "itemData",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:itemData}}",
                                "valueLabel": "",
                                "propLabel": "Item Data"
                              },
                              {
                                "prop": "parent_trx_no",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:parent_no}}",
                                "valueLabel": "",
                                "propLabel": "Parent Trx No"
                              },
                              {
                                "prop": "isMovingInv",
                                "operator": "",
                                "valueType": "value",
                                "value": 0,
                                "valueLabel": "",
                                "propLabel": "Moving Inventory?"
                              },
                              {
                                "prop": "doc_date",
                                "operator": "",
                                "valueType": "field",
                                "value": "{{workflowparams:doc_date}}",
                                "valueLabel": "",
                                "propLabel": "Doc Date"
                              }
                            ]
                          }
                        },
                        "blocks": []
                      },
                      {
                        "id": "if_VNR14R3p",
                        "type": "if",
                        "data": {
                          "title": "IF subtractInventory Failed",
                          "isValidator": true,
                          "nodeName": "IF subtractInventory Failed",
                          "name": "IF subtractInventory Failed",
                          "condition_type": "Expression",
                          "filter": {
                            "list": [
                              {
                                "id": 1736695973613,
                                "parentId": 1736695973612,
                                "isTop": true,
                                "prop": "",
                                "operator": "",
                                "valueType": "",
                                "value": "",
                                "type": "leaf",
                                "level": 1
                              }
                            ]
                          },
                          "expression": {
                            "type": "javascript",
                            "code": "'{{node:workflow_node_QTdqcGY1.data.code}}' == '400'"
                          }
                        },
                        "blocks": [
                          {
                            "id": "ifBlock_pkPFg8vt",
                            "type": "ifBlock",
                            "data": { "title": "true" },
                            "blocks": [
                              {
                                "id": "return_node_SYYxigXf",
                                "type": "return-node",
                                "data": {
                                  "return_data": {},
                                  "status_code": 200,
                                  "title": "Return Data",
                                  "isValidator": true,
                                  "nodeName": "Return Data",
                                  "name": "Return Data",
                                  "response_value": {
                                    "list": [
                                      {
                                        "prop": "code",
                                        "propLabel": "code",
                                        "operator": "",
                                        "operatorLabel": "",
                                        "valueType": "value",
                                        "valueTypeLabel": "",
                                        "value": "400",
                                        "valueLabel": ""
                                      },
                                      {
                                        "prop": "message",
                                        "operator": "",
                                        "valueType": "field",
                                        "value": "{{node:workflow_node_QTdqcGY1.data.errorMessage}}",
                                        "valueLabel": "",
                                        "propLabel": "message"
                                      }
                                    ]
                                  },
                                  "return_raw_data": 0
                                },
                                "blocks": []
                              }
                            ]
                          },
                          {
                            "id": "ifBlock_i5ohw1lX",
                            "type": "ifBlock",
                            "data": { "title": "false" },
                            "blocks": []
                          }
                        ]
                      },
                      {
                        "id": "set_cache_node_Nuuj9DI6",
                        "type": "set-cache-node",
                        "data": {
                          "cache_key": "",
                          "cache_value": "",
                          "expire_time": 3600,
                          "title": "Set inventoryMovements nextIndex",
                          "isValidator": true,
                          "nodeName": "Set inventoryMovements nextIndex",
                          "name": "Set inventoryMovements nextIndex",
                          "custom_wkbocgni": {
                            "type": "javascript",
                            "code": "{{node:code_node_2uHAOiqe.data.nextIndex}}"
                          },
                          "redis_key": "inventoryMovementsIndex"
                        },
                        "blocks": []
                      }
                    ]
                  }
                ]
              },
              {
                "id": "ifBlock_9oM4rR9t",
                "type": "ifBlock",
                "data": { "title": "false" },
                "blocks": []
              }
            ]
          },
          {
            "id": "return_node_6boObut9",
            "type": "return-node",
            "data": {
              "return_data": {},
              "status_code": 200,
              "title": "Return Data",
              "isValidator": true,
              "nodeName": "Return Data",
              "name": "Return Data",
              "response_value": {
                "list": [
                  {
                    "prop": "code",
                    "propLabel": "code",
                    "operator": "",
                    "operatorLabel": "",
                    "valueType": "field",
                    "valueTypeLabel": "",
                    "value": "{{node:code_node_xtldYT5d.data.code}}",
                    "valueLabel": ""
                  },
                  {
                    "prop": "message",
                    "operator": "",
                    "valueType": "field",
                    "value": "{{node:code_node_xtldYT5d.data.message}}",
                    "valueLabel": "",
                    "propLabel": "message"
                  }
                ]
              },
              "return_raw_data": 0
            },
            "blocks": []
          }
        ]
      },
      {
        "id": "condition_or_node_item_Gd1YJ2c7",
        "type": "condition-or-node-item",
        "data": {
          "title": "Invalid Status",
          "isDefault": true,
          "filter": { "list": [] },
          "expression": { "code": "" },
          "displayContent": "sdk.form.otherCondition"
        },
        "blocks": [
          {
            "id": "return_node_WWReIhME",
            "type": "return-node",
            "data": {
              "return_data": {},
              "status_code": 200,
              "title": "Return Data",
              "isValidator": true,
              "nodeName": "Return Data",
              "name": "Return Data",
              "response_value": {
                "list": [
                  {
                    "prop": "code",
                    "propLabel": "code",
                    "operator": "",
                    "operatorLabel": "",
                    "valueType": "value",
                    "valueTypeLabel": "",
                    "value": "400",
                    "valueLabel": ""
                  },
                  {
                    "prop": "message",
                    "operator": "",
                    "valueType": "value",
                    "value": "Invalid status",
                    "valueLabel": "",
                    "propLabel": "message"
                  }
                ]
              },
              "return_raw_data": 0
            },
            "blocks": []
          }
        ]
      }
    ]
  }
]
