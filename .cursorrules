# Scratchpad

## Current Task: Fix Putaway split item serial number deduction

### Problem Analysis:

- In PutawaySaveAsInProgress.js, the `calculateLeftoverSerialNumbers` function didn't properly handle split scenarios
- For split items, the parent item should have its serial numbers reduced by the sum of all child items' processed serial numbers
- Child items should only reduce serial numbers based on their own processing
- The previous logic only looked at individual item's `select_serial_number`, missing the aggregation needed for split parent items

### Solution Implemented:

[X] **CRITICAL FIX**: Enhanced `calculateLeftoverSerialNumbers` function to handle split scenarios
[X] **SPLIT LOGIC**: Added logic to aggregate processed serial numbers from all child items for parent items
[X] **PARAMETER PASSING**: Updated function signature to accept `allItems` and `itemIndex` parameters for split handling
[X] **FORM UPDATES**: Enhanced form data updates to properly persist leftover serial numbers for both parent and child items
[X] **COMPREHENSIVE LOGGING**: Added detailed logging for split scenario debugging
[X] **PARENT COMPLETION FIX**: Fixed parent item serial number clearing when all child items are completed

### Fix Details:

**Enhanced calculateLeftoverSerialNumbers Function:**

- **Split Parent Items**: For parent items in split scenarios, collects all processed serial numbers from child items
- **Child Items**: For child items, uses their own `select_serial_number` array
- **Non-Split Items**: Maintains original behavior for standalone items
- **Aggregation Logic**: Properly aggregates serial numbers across multiple child items

**Split Scenario Handling:**

```javascript
if (item.parent_or_child === "Parent" && item.is_split === "Yes" && allItems) {
  // Collect all processed serial numbers from child items
  const childItems = allItems.filter(
    (childItem, childIndex) =>
      childItem.parent_index === itemIndex &&
      childItem.parent_or_child === "Child" &&
      childItem.item_code === item.item_code
  );

  // Aggregate all processed serial numbers from child items
  childItems.forEach((childItem) => {
    if (Array.isArray(childItem.select_serial_number)) {
      const childProcessedSerials = childItem.select_serial_number
        .map((sn) => sn.trim())
        .filter((sn) => sn !== "");

      allProcessedSerialNumbers = allProcessedSerialNumbers.concat(
        childProcessedSerials
      );
    }
  });
}
```

**Form Data Updates:**

- Updates `line_status` for all items (parent and child)
- Updates `pending_process_qty` for proper quantity tracking
- Updates `serial_numbers` for serialized items to reflect leftover serials
- Special handling for parent items in split scenarios to show correct leftover serial numbers

**Parent Item Completion Logic:**

- Added serial number handling in the parent item processing section
- When `parentPendingProcessQty === 0`, clears all serial numbers from parent item
- When `parentPendingProcessQty > 0`, calculates leftover serial numbers using child aggregation
- Ensures parent items show correct serial number state based on child completion status

### Example Split Scenario:

- **Original Serial Numbers**: `"SN001, SN002, SN003, SN004"`
- **Child 1 Processed**: `["SN001", "SN002"]`
- **Child 2 Processed**: `["SN003"]`
- **Parent Leftover**: `"SN004"`

The parent item will correctly show `SN004` as the leftover serial number after both child items have processed their respective serial numbers.

### Testing Required:

[X] Test split serialized items: verify parent serial numbers are correctly reduced by child processing
[X] Test multiple child items: verify aggregation works across multiple child items
[X] Test partial processing: verify leftover serial numbers are correctly calculated for split scenarios
[X] Test form persistence: verify leftover serial numbers are properly saved for both parent and child items

## Previous Completed Tasks:

### Fix Picking serial number removal for leftover processing - COMPLETED

[X] **CRITICAL FIX**: Added `calculateLeftoverSerialNumbers` helper function to handle serial number removal logic
[X] **ENHANCED**: Modified `validateAndUpdateLineStatuses` function to update serial numbers based on processing status
[X] **UPDATED**: Enhanced form data updates to persist leftover serial numbers back to the form
[X] **LOGGING**: Added comprehensive logging for serial number processing and leftover calculations

## Previous Completed Tasks:

### Fix Stock Movement createSerialNumberRecord for Misc Receipt - COMPLETED

[X] **CRITICAL FIX**: Fixed createSerialNumberRecord function to use generated_serial_numbers instead of raw serial_number_data
[X] **ENHANCED**: Modified addSerialNumberInventoryForSM to store generated_serial_numbers array in the item data structure
[X] **UPDATED**: Changed createSerialNumberRecord to use generated_serial_numbers.join("\n") like Goods Receiving process
[X] **ALIGNED**: Ensured Stock Movement follows the same pattern as Goods Receiving for serial number record creation

### Fix inventory dialog temp_qty_data missing location_id - COMPLETED

[X] Enhanced the filteredData creation in GDconfirmDialog.js to ensure all required fields are preserved
[X] **CRITICAL FIX**: Modified GDgdQty.js to preserve inventory dialog allocations instead of overwriting them
[X] Added detection in GDgdQty.js to identify inventory dialog allocations (by checking for location_id)
[X] This ensures the mergeWithTempData function in GDinventoryDialog.js can properly match records

### Fix Stock Adjustment WA/FIFO updates for serialized items - COMPLETED

[X] Modified `processSerializedItemAdjustment` to calculate net quantity changes for costing
[X] Added costing method updates for serialized items by calling `updateQuantities()`
[X] Enhanced `updateQuantities()` function to accept parameters for reuse in serialized item context
[X] Updated all references within `updateQuantities()` to use the passed parameters

### Fix Putaway item_serial_balance incorrect balance handling - COMPLETED

[X] **CRITICAL FIX**: Completely rewrote `processSerialBalanceMovement` in both putaway files
[X] **MAJOR CHANGE**: Replaced `available_qty` logic with proper balance quantity management
[X] Added support for all inventory categories (Unrestricted, Reserved, Quality Inspection, Blocked, In Transit)
[X] Implemented proper OUT/IN movement handling with correct category-based quantity updates

### Fix Putaway split item handling inconsistency - COMPLETED

[X] **CRITICAL FIX**: Fixed createPutawayRecords logic in PutawaySaveAsInProgress.js
[X] **CRITICAL FIX**: Fixed validateAndUpdateLineStatuses logic in PutawaySaveAsInProgress.js
[X] Ensured consistency between PutawaySaveAsInProgress.js and PutawaySaveAsCompleted.js
[X] Verified serialized items now follow same flow as non-serialized items for split cases
